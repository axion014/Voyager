function Slot(e){for(var t=Math.random()*e.reduce(function(e,t){return e+t.weight},0),i=0,s=0;;s++)if(i+=e[s].weight,i>=t)return"function"==typeof e[s].target?e[s].target():e[s].target}phina.namespace(function(){var e=phina.display.Label.prototype.init;phina.display.Label.prototype.init=function(){e.apply(this,arguments),this.accessor("width",{get:phina.display.Label.prototype.calcCanvasWidth,set:function(e){}}),this.accessor("height",{get:phina.display.Label.prototype.calcCanvasHeight,set:function(e){}})}}),phina.namespace(function(){var e=phina.ui.LabelArea.prototype.init;phina.ui.LabelArea.prototype.init=function(t){t={}.$safe(t,phina.ui.LabelArea.defaults),e.call(this,t),Object.defineProperty(this,"width",{value:void 0===t.width?64:t.width,enumerable:!0,writable:!0}),Object.defineProperty(this,"height",{value:void 0===t.height?64:t.height,enumerable:!0,writable:!0})}}),phina.define("phina.display.Screen",{superClass:"phina.display.RectangleShape",init:function(e){e=(e||{}).$safe({fill:null,backgroundColor:"transparent"}),this.superInit(e),this.scroll=phina.geom.Vector2(0,0),this.zoom=1},clip:function(e){e.beginPath(),e.setTransform(this._cr*this.scale.x,this._sr*this.scale.y,-this._sr*this.scale.x,this._cr*this.scale.y,this.position.x,this.position.y),e.rect(-this.width*this.origin.x,-this.height*this.origin.y,this.width,this.height)},_calcWorldMatrix:function(){if(this.parent){if(this.rotation!=this._cachedRotation){this._cachedRotation=this.rotation;var e=this.rotation*(Math.PI/180);this._sr=Math.sin(e),this._cr=Math.cos(e)}var t=this._matrix,i=this.parent._worldMatrix||phina.geom.Matrix33.IDENTITY,s=this._worldMatrix;t.m00=this._cr*this.scale.x*this.zoom,t.m01=-this._sr*this.scale.y*this.zoom,t.m10=this._sr*this.scale.x*this.zoom,t.m11=this._cr*this.scale.y*this.zoom;var a=-this.scroll.x*this.zoom*this.scale.x,n=-this.scroll.y*this.zoom*this.scale.y;t.m02=this.position.x-this.width*(this.origin.x-.5)+a*this._cr-n*this._sr,t.m12=this.position.y-this.height*(this.origin.y-.5)+a*this._sr+n*this._cr;var r=t.m00,o=t.m01,l=t.m02,h=t.m10,c=t.m11,p=t.m12,d=i.m00,u=i.m01,f=i.m02,g=i.m10,m=i.m11,y=i.m12;return s.m00=d*r+u*h,s.m01=d*o+u*c,s.m02=d*l+u*p+f,s.m10=g*r+m*h,s.m11=g*o+m*c,s.m12=g*l+m*p+y,this}},where:function(e){return Vector2((e.x-this.scroll.x)*this.zoom+this.width/2,(e.y-this.scroll.y)*this.zoom+this.height/2)},_accessor:{scrollX:{get:function(){return this.scroll.x},set:function(e){this.scroll.x=e}},scrollY:{get:function(){return this.scroll.y},set:function(e){this.scroll.y=e}}}});var SCREEN_WIDTH=640,SCREEN_HEIGHT=960,SCREEN_CENTER_X=SCREEN_WIDTH/2,SCREEN_CENTER_Y=SCREEN_HEIGHT/2,Axis={x:new THREE.Vector3(1,0,0).normalize(),y:new THREE.Vector3(0,1,0).normalize(),z:new THREE.Vector3(0,0,1).normalize()},opt=function(e,t){return void 0===e[t]?function(){}:e[t]instanceof Function?e[t].bind(e):e[t]},threeext=threeext||{};threeext.$method("extention",function(){THREE.$method("$extend",function(e,t){var i=Array.prototype.slice.call(arguments);return i.shift(),Array.prototype.forEach.call(i,function(i){for(var s in i)e[s]&&t[s]&&t[s].className&&"THREE."===t[s].className.substr(0,6)?e[s].copy(t[s]):e[s]=t[s]},this),e}),THREE.$method("$add",function(e,t){var i=Array.prototype.slice.call(arguments);return i.shift(),Array.prototype.forEach.call(i,function(i){for(var s in i)t[s]||(e[s]&&t[s]&&t[s].className&&"THREE."===t[s].className.substr(0,6)?e[s].add(t[s]):e[s]+=t[s])},this),e}),THREE.$method("applyToAllMaterial",function(e,t){Array.isArray(e)?e.each(t):t(e)}),THREE.Object3D.prototype.$method("rotate",function(e,t){this.quaternion.rotate(e,t)}),THREE.Object3D.prototype.$method("rotateAbs",function(e,t){this.quaternion.rotateAbs(e,t)}),THREE.Object3D.prototype.$method("move",function(e){return this.position.x=e.x,this.position.y=e.y,this.position.z=e.z,this}),THREE.Object3D.prototype.$method("rotateAbsX",function(e){this.quaternion.rotateAbsX(e)}),THREE.Object3D.prototype.$method("rotateAbsY",function(e){this.quaternion.rotateAbsY(e)}),THREE.Object3D.prototype.$method("rotateAbsZ",function(e){this.quaternion.rotateAbsZ(e)}),THREE.Mesh.prototype.$method("deepclone",function(e,t){return new this.constructor(e?this.geometry.clone():this.geometry,t?this.material.clone(!0):this.material).copy(this)}),THREE.Mesh.prototype.getter("tweener",function(){return this._tweener||(this._tweener=phina.accessory.Tweener().attachTo(this)),this._tweener}),function(){var e=["addEventListener","on","removeEventListener","off","clearEventListener","clear","hasEventListener","has","dispatchEvent","fire","dispatchEventByType","flare","attach","attachTo","detach"];e.each(function(e){THREE.Mesh.prototype.$method(e,phina.app.Element.prototype[e]),THREE.Vector3.prototype.$method(e,phina.app.Element.prototype[e])})}(),THREE.Mesh.prototype._listeners={},THREE.Vector3.prototype._listeners={},THREE.Vector3.prototype.className="THREE.Vector3",THREE.Quaternion.prototype.className="THREE.Quaternion",THREE.Quaternion.prototype.$method("rotate",function(e,t){return this.multiply((new THREE.Quaternion).setFromAxisAngle(e,t))}),THREE.Quaternion.prototype.$method("rotateX",function(e){return this.rotate(Axis.x,e)}),THREE.Quaternion.prototype.$method("rotateY",function(e){return this.rotate(Axis.y,e)}),THREE.Quaternion.prototype.$method("rotateZ",function(e){return this.rotate(Axis.z,e)}),THREE.Quaternion.prototype.$method("rotateAbs",function(e,t){return this.premultiply((new THREE.Quaternion).setFromAxisAngle(e,t))}),THREE.Quaternion.prototype.$method("rotateAbsX",function(e){return this.rotateAbs(Axis.x,e)}),THREE.Quaternion.prototype.$method("rotateAbsY",function(e){return this.rotateAbs(Axis.y,e)}),THREE.Quaternion.prototype.$method("rotateAbsZ",function(e){return this.rotateAbs(Axis.z,e)}),THREE.Vector3.prototype.getter("tweener",function(){return this._tweener||(this._tweener=phina.accessory.Tweener().attachTo(this)),this._tweener}),THREE.MultiMaterial.prototype.accessor("opacity",{set:function(e){for(var t=0;t<this.materials.length;t++)this.materials[t].opacity=e},get:function(){return this.materials[0].opacity}})}),phina.define("SimpleUpdater",{superClass:"phina.app.Element",init:function(){this.superInit(),this.elements=[]},update:function(){this.each(function(e){e.update()})},get:function(e){return this.elements[e]},remove:function(e){this.elements.splice(e,1)},count:function(e){return this.elements.length},each:function(e,t){this.elements.each(e,t)}}),phina.define("fly.DirectionShape",{superClass:"phina.display.Shape",init:function(e){e={}.$safe(e,{backgroundColor:"transparent",fill:"#ff5050",stroke:"#aaa",strokeWidth:2,width:16,height:32}),this.superInit(e)},prerender:function(e){e.beginPath().moveTo(0,this.height).lineTo(this.width,-this.height).lineTo(-this.width,-this.height).closePath()},initThreeMesh:function(){var e=new THREE.Group,t=new THREE.Shape;t.moveTo(0,-1),t.lineTo(1,1),t.lineTo(-1,1),t.lineTo(0,-1);var i=new THREE.ShapeGeometry(t);return e.fill=new THREE.Mesh(i,new THREE.MeshBasicMaterial),e.fill.position.z=1,e.stroke=new THREE.Mesh(i,new THREE.MeshBasicMaterial),e.add(e.stroke),e.add(e.fill),e},updateThreeMesh:function(e,t){function i(e,t,i){if(!t)return void(e.visible=!1);var s=phina.util.Color().setFromString(t);return s.a?(e.color=new THREE.Color(s.r/255,s.g/255,s.b/255),s.a*=void 0!==i?i:1,e.opacity=s.a,e.transparent=1!==s.a,void(e.visible=!0)):void(e.visible=!1)}i(e.fill.material,this.fill,t),e.fill.scale.set(this.width*this.scaleX,this.height*this.scaleY,1),i(e.stroke.material,this.stroke,t),e.stroke.scale.set((1+this.strokeWidth/this.width)*this.width*this.scaleX,(1+this.strokeWidth/this.height)*this.height*this.scaleY,1)}}),phina.define("MarkShape",{superClass:"phina.display.Shape",init:function(e){e={}.$safe(e,{backgroundColor:"transparent",stroke:"#444",strokeWidth:1,width:16,height:16}),this.superInit(e)},render:function(e){e.clearColor(this.backgroundColor),e.transformCenter(),this.isStrokable()&&(e.lineWidth=this.strokeWidth,e.strokeStyle=this.stroke,e.drawLine(-this.width,0,this.width,0),e.drawLine(0,-this.height,0,this.height))},initThreeMesh:function(){var e=new THREE.Group,t=new THREE.PlaneGeometry(1,1);return e.vertical=new THREE.Mesh(t,new THREE.MeshBasicMaterial),e.horizontal=new THREE.Mesh(t,new THREE.MeshBasicMaterial),e.add(e.vertical),e.add(e.horizontal),e},updateThreeMesh:function(e,t){function i(e,t,i){if(!t)return void(e.visible=!1);var s=phina.util.Color().setFromString(t);return s.a?(e.color=new THREE.Color(s.r/255,s.g/255,s.b/255),s.a*=void 0!==i?i:1,e.opacity=s.a,e.transparent=1!==s.a,void(e.visible=!0)):void(e.visible=!1)}i(e.vertical.material,this.stroke,t),e.vertical.scale.set(this.strokeWidth*this.scaleX,this.height*this.scaleY,1),i(e.horizontal.material,this.stroke,t),e.horizontal.scale.set(this.width*this.scaleX,this.strokeWidth*this.scaleY,1)}}),phina.define("fly.asset.ThreeJSON",{superClass:"phina.asset.Asset",data:null,init:function(){this.superInit()},_load:function(e){var t=this,i=new THREE.JSONLoader;i.crossOrigin="",i.load(this.src,function(i,s){t.data=new THREE.Mesh(i,s),e(t)})},get:function(){return this.data.deepclone.apply(this.data,arguments)}}),phina.define("fly.asset.ThreeTexture",{superClass:"phina.asset.Asset",_asset:null,init:function(){this.superInit()},_load:function(e){var t=this,i=new THREE.TextureLoader;i.crossOrigin="",i.load(this.src,function(i){t._asset=i,e(t)})},get:function(){var e=this._asset.clone();return e.needsUpdate=!0,e}}),phina.define("fly.asset.ThreeCubeTex",{superClass:"phina.asset.Asset",_asset:null,init:function(){this.superInit()},_load:function(e){var t=this,s=this.src.split(" ",2),a=[];for(i=0;i<6;i++)a[i]=s[0]+i+s[1];(new THREE.CubeTextureLoader).load(a,function(i){var s=THREE.ShaderLib.cube;s.uniforms.tCube.value=i,t._asset=new THREE.Mesh(new THREE.BoxGeometry(1e4,1e4,1e4),new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:s.uniforms,depthWrite:!1,side:THREE.BackSide})),e(t)})},get:function(){return this._asset.clone()}}),phina.define("fly.asset.Stage",{superClass:"phina.asset.Asset",data:{},init:function(){this.superInit()},_load:function(e){var t=this,i=phina.asset.File();i.load({path:this.src,dataType:"json"}).then(function(){var s=i.data;s.$safe({enemys:[],obstacles:[],winds:[],messages:[],goals:[]});for(var a=0;a<s.enemys.length;a++)s.enemys[a].$safe({position:{},rotation:{},option:{},autospawn:{},random:{},killmes:{}}),s.enemys[a].rotation.$safe({a:{}}),s.enemys[a].autospawn.$safe({time:0,progress:0,random:{}}),s.enemys[a].autospawn.random.$safe({x:0,y:0,z:0}),s.enemys[a].killmes.$safe({time:0,text:"",offkill:!1}),s.enemys[a].option.$safe({position:new THREE.Vector3(s.enemys[a].position.x||0,s.enemys[a].position.y||0,s.enemys[a].position.z||0),quaternion:(new THREE.Quaternion).rotate(new THREE.Vector3(s.enemys[a].rotation.a.x||0,s.enemys[a].rotation.a.y||0,s.enemys[a].rotation.a.z||0),s.enemys[a].rotation.r||0),c:(new THREE.Quaternion).rotate(new THREE.Vector3(s.enemys[a].rotation.a.cx||0,s.enemys[a].rotation.a.cy||0,s.enemys[a].rotation.a.cz||0),s.enemys[a].rotation.cr||0)});for(var a=0;a<s.winds.length;a++)s.winds[a].$safe({v:.2,x:0,y:0,color:[0,0,0]}),s.winds[a].position=new THREE.Vector2(s.winds[a].x,s.winds[a].y),s.winds[a].c=s.winds[a].color[0]<<16|s.winds[a].color[1]<<8|s.winds[a].color[2];for(var a=0;a<s.obstacles.length;a++)s.obstacles[a].$safe({position:{},rotation:{},scale:{}}),s.obstacles[a].rotation.$safe({a:{}}),s.obstacles[a].position=new THREE.Vector3(s.obstacles[a].position.x||0,s.obstacles[a].position.y||0,s.obstacles[a].position.z||0),s.obstacles[a].quaternion=(new THREE.Quaternion).rotate(new THREE.Vector3(s.obstacles[a].rotation.a.x||0,s.obstacles[a].rotation.a.y||0,s.obstacles[a].rotation.a.z||0),s.obstacles[a].rotation.r||0),s.obstacles[a].scale=new THREE.Vector3(s.obstacles[a].scale.x||100,s.obstacles[a].scale.y||100,s.obstacles[a].scale.z||100);for(var a=0;a<s.messages.length;a++)s.messages[a].$safe({time:0,text:""});for(var a=0;a<s.goals.length;a++)s.goals[a].$safe({x:0,y:0,z:0,size:100,kill:0,message:""});this.data=s,e(t)}.bind(this))},get:function(){return this.data}}),phina.asset.AssetLoader.assetLoadFunctions.threejson=function(e,t){var i=fly.asset.ThreeJSON(),s=i.load(t);return s},phina.asset.AssetLoader.assetLoadFunctions.threetexture=function(e,t){var i=fly.asset.ThreeTexture(),s=i.load(t);return s},phina.asset.AssetLoader.assetLoadFunctions.threecubetex=function(e,t){var i=fly.asset.ThreeCubeTex(),s=i.load(t);return s},phina.asset.AssetLoader.assetLoadFunctions.stage=function(e,t){var i=fly.asset.Stage(),s=i.load(t);return s},fly.colCup2D3=function(e,t,i,s,a){var n=t.clone().sub(e),r=s.clone().multiplyScalar(i.clone().dot(s)/s.clone().dot(s)).sub(i),o=r.clone().dot(r);if(o<1e-5){var l=t.clone().sub(e).length();l=Math.min(l,t.clone().add(s).sub(e).length()),l=Math.min(l,t.clone().sub(e.clone().add(i)).length()),l=Math.min(l,t.clone().add(s).sub(e.clone().add(i)).length());var h=t.clone().add(s.multiplyScalar(n.clone().dot(s)/s.clone().dot(s)*-1)),c=Math.min(l,h.sub(e).length())}else var p=s.clone().dot(s),d=Math.clamp(r.clone().dot(n.clone().dot(s)/p*s.clone().sub(n))/o,0,1),u=Math.clamp(i.clone().multiplyScalar(d).sub(n).dot(s)/p,0,1),c=t.clone().add(s.clone().multiplyScalar(u)).sub(e.clone().add(i.clone().multiplyScalar(d))).length();return c<=a},fly.colcupsphere=function(e,t,i,s,a){var n=Math.max(i.clone().sub(e).dot(t),0);return a&&n>1&&(n=1),i.clone().sub(e.clone().addScaledVector(t,n)).length()<=s},fly.colobbsphere=function(e,t,i,s,a){var n=new THREE.Vector3(0,0,0),r=t.clone().sub(e);if(i.x>0){var o=Axis.x.clone().applyQuaternion(s),l=Math.abs(r.dot(o)/i.x);l>1&&n.add((1-l)*i.x*o)}return i.y>0&&(o=Axis.y.clone().applyQuaternion(s),l=Math.abs(r.dot(o)/i.y),l>1&&n.add((1-l)*i.y*o)),i.z>0&&(o=Axis.z.clone().applyQuaternion(s),l=Math.abs(r.dot(o)/i.z),l>1&&n.add((1-l)*i.z*o)),n.length()<=a},phina.define("fly.Popup",{superClass:"phina.display.Shape",init:function(e){e={}.$safe(e,{backgroundColor:"transparent",fill:"hsla(0, 0%, 0%, 0.6)",stroke:null,strokeWidth:2,width:512,height:48,sideIndent:32}),this.superInit(e),this.sideIndent=e.sideIndent,this.label=phina.display.Label(e.label).addChildTo(this)},prerender:function(e){var t=this.width/2,i=this.height/2;e.beginPath().moveTo(-t,-i).lineTo(this.sideIndent-t,0).lineTo(-t,i).lineTo(t,i).lineTo(t-this.sideIndent,0).lineTo(t,-i).closePath()},initThreeMesh:function(){var e=new THREE.Group,t=new THREE.Shape;t.moveTo(-1,-.5),t.lineTo(0,0),t.lineTo(-1,.5),t.lineTo(0,.5),t.lineTo(0,-.5),t.lineTo(-1,-.5);var i=new THREE.ShapeGeometry(t),s=new THREE.PlaneGeometry(1,1);return e.fill=new THREE.Mesh(s,new THREE.MeshBasicMaterial),e.fill.position.z=1,e.stroke=new THREE.Mesh(s,new THREE.MeshBasicMaterial),e.fillleft=new THREE.Mesh(i,new THREE.MeshBasicMaterial),e.fillleft.position.z=1,e.strokeleft=new THREE.Mesh(i,new THREE.MeshBasicMaterial),e.fillright=new THREE.Mesh(i,new THREE.MeshBasicMaterial({side:THREE.BackSide})),e.fillright.position.z=1,e.strokeright=new THREE.Mesh(i,new THREE.MeshBasicMaterial({side:THREE.BackSide})),e.add(e.stroke),e.add(e.fill),e.add(e.strokeleft),e.add(e.fillleft),e.add(e.strokeright),e.add(e.fillright),e},updateThreeMesh:function(e,t){function i(e,t,i){if(!t)return void(e.visible=!1);var s=phina.util.Color().setFromString(t);return s.a?(e.color=new THREE.Color(s.r/255,s.g/255,s.b/255),s.a*=void 0!==i?i:1,e.opacity=s.a,e.transparent=1!==s.a,void(e.visible=!0)):void(e.visible=!1)}var s=this.width-2*this.sideIndent;i(e.fill.material,this.fill,t),e.fill.scale.set(s*this.scaleX,this.height*this.scaleY,1),i(e.stroke.material,this.stroke,t),e.stroke.scale.set((1+this.strokeWidth/s)*s*this.scaleX,(1+this.strokeWidth/this.height)*this.height*this.scaleY,1),i(e.fillleft.material,this.fill,t),e.fillleft.scale.set(2*this.sideIndent*this.scaleX,this.height*this.scaleY,1),e.fillleft.position.x=-s*this.scaleX/2,i(e.strokeleft.material,this.stroke,t),e.strokeleft.scale.set((1+this.strokeWidth/this.sideIndent/2)*this.sideIndent*2*this.scaleX,(1+this.strokeWidth/this.height)*this.height*this.scaleY,1),e.strokeleft.position.x=-s*this.scaleX/2,i(e.fillright.material,this.fill,t),e.fillright.scale.set(2*-this.sideIndent*this.scaleX,this.height*this.scaleY,1),e.fillright.position.x=s*this.scaleX/2,i(e.strokeright.material,this.stroke,t),e.strokeright.scale.set(-(1+this.strokeWidth/this.sideIndent/2)*this.sideIndent*2*this.scaleX,(1+this.strokeWidth/this.height)*this.height*this.scaleY,1),e.strokeright.position.x=s*this.scaleX/2}}),phina.define("EffectManager",{superClass:"SimpleUpdater",init:function(e){this.superInit(),this.explodeManager=ExplodeManager(e).addChildTo(this),this.rayManager=RayManager(e).addChildTo(this),this.threescene=e},explode:function(e,t,i){return this.explodeManager.explode(e,t,i)},ray:function(e,t,i,s,a,n){return this.rayManager.ray(e,t,i,s,a,n)}}),phina.define("ExplodeManager",{superClass:"SimpleUpdater",init:function(e){this.superInit(),this.threescene=e},explode:function(e,t,i){var s=new THREE.ShaderMaterial({transparent:!0,uniforms:{tExplosion:{type:"t",value:phina.asset.AssetManager.get("threetexture","explode").get()},time:{type:"f",value:100*Math.random()},alpha:{type:"f",value:1}},vertexShader:phina.asset.AssetManager.get("text","expvertexshader").data,fragmentShader:phina.asset.AssetManager.get("text","expfragshader").data}),a=new THREE.Mesh(new THREE.IcosahedronGeometry(20,2),s).$safe({time:i,timeMax:i}).$safe({time:10,timeMax:10,update:function(){this.time--,s.uniforms.time.value+=.015*Math.random(),s.uniforms.alpha.value=this.time/this.timeMax}});return a.move(e),a.scale.set(t,t,t),this.threescene.add(a),this.elements.push(a),a},update:function(){for(var e=0;e<this.count();e++)this.get(e).update(),0===this.get(e).time&&(this.get(e).parent.remove(this.get(e)),this.remove(e),e--)}}),phina.define("RayManager",{superClass:"SimpleUpdater",init:function(e){this.superInit(),this.threescene=e},ray:function(e,t,i,s,a){e.geometry.boundingBox||e.geometry.computeBoundingBox();var n=this;if(a){var r=new THREE.Mesh(new THREE.SphereGeometry(s,20,10,0,2*Math.PI,0,Math.PI/2));r.position.y=500;var o=new THREE.Mesh(new THREE.CylinderGeometry(s,s,1e3,20,10),new THREE.MeshBasicMaterial({color:t,opacity:i,transparent:!0})).$safe({generator:e,offset:500+s+e.geometry.boundingBox.max.z,time:a,update:function(){return this.time--,0===this.time?(this.parent.remove(this),void n.elements.erase(this)):(this.move(this.generator.position.clone().add(Axis.z.clone().applyQuaternion(this.generator.quaternion).setLength(this.offset))),this.quaternion.copy(new THREE.Quaternion),this.rotateY(Math.PI),this.rotateX(Math.PI/2),void this.quaternion.premultiply(this.generator.quaternion))}});return o.geometry.mergeMesh(r),this.threescene.add(o),this.elements.push(o),o}var l=t,h=[];return h.$safe({generator:e,offset:500+l.reduce(function(e,t){return e>t.radius?e:t.radius},0)+e.geometry.boundingBox.max.z,time:0,timeMax:i,radiusfunc:s,update:function(){this.time++;var e=h.radiusfunc(this.time,this.timeMax);this.each(function(t){return this.time===this.timeMax?void t.parent.remove(t):(t.move(this.generator.position.clone().add(Axis.z.clone().applyQuaternion(this.generator.quaternion).setLength(this.offset))),t.quaternion.copy(new THREE.Quaternion),t.rotateY(Math.PI),t.rotateX(Math.PI/2),t.quaternion.premultiply(this.generator.quaternion),void(t.scale.x=t.scale.z=e))},this),this.time===this.timeMax&&n.elements.erase(this)}}),l.each(function(e){var t=new THREE.Mesh(new THREE.SphereGeometry(e.radius,20,10,0,2*Math.PI,0,Math.PI/2));t.position.y=500;var i=new THREE.Mesh(new THREE.CylinderGeometry(e.radius,e.radius,1e3,20,10),new THREE.MeshBasicMaterial({color:e.color,opacity:e.opacity,transparent:!0}));i.geometry.mergeMesh(t),this.threescene.add(i),h.push(i)},this),this.elements.push(h),h}}),phina.define("AllyManager",{superClass:"SimpleUpdater",allyraders:[],deathcount:0,init:function(e,t){this.superInit(),this.scene=e,this.threescene=t},create:function(e,t,i,s){if(s){var a=function(n){n.progress>s&&(this.create(e,t,i),this.off("frame",a))};this.on("frame",a)}else{if(!i){var n=UnitManager.get(e).mesh.get(!1,!0);THREE.$extend(n,UnitManager.get(e).routine),THREE.$extend(n,t),n.summons=this,this.threescene.add(n),this.elements.push(n);var r=phina.display.CircleShape({radius:3,fill:"hsla(210, 80%, 60%, 0.5)",stroke:"hsla(0, 0%, 0%, 0.5)",strokeWidth:1}).addChildTo(this.scene),o=this.player.position.x-n.position.x,l=this.player.position.z-n.position.z,h=Math.min(Math.sqrt(Math.pow(o,2)+Math.pow(l,2))/25,75),c=Math.atan2(o,l)-this.player.myrot.y+(Math.abs(this.player.myrot.x)>Math.PI/2&&Math.abs(this.player.myrot.x)<1.5*Math.PI?Math.PI:0);return r.setPosition(SCREEN_WIDTH-100+Math.sin(c)*h,SCREEN_HEIGHT-100+Math.cos(c)*h),this.allyraders.push(r),n.stealth&&r.hide(),n}this.on("frame"+(this.scene.frame+i),this.create.bind(this,e,t))}},createMulti:function(e,t,i,s){var a=i.$safe(UnitManager.get(e).autospawn);t.boss&&(this.scene.bossdefeated=!1);for(var n=0;n<a.rep;n++){var r={position:new THREE.Vector3};THREE.$extend(r,t),this.create(e,r,this.groups.last,a.time,a.progress),a.delay&&(a.time+=a.delay),THREE.$add(t,a.options),t.position.add(new THREE.Vector3(Math.random()*a.random.x*2-a.random.x,Math.random()*a.random.y*2-a.random.y,Math.random()*a.random.z*2-a.random.z))}},update:function(){this.each(function(e,t){if(this.opponents.bulletManager.hitTest(e),e.update(this),e.despawn)return void this.removeAlly(t);if(e.hp<=0)return void this.kill(t);e.time++;var i=this.player.position.x-e.position.x,s=this.player.position.z-e.position.z,a=Math.sqrt(Math.pow(i,2)+Math.pow(s,2))/25;if(e.stealth||a>100)return void this.allyraders[t].hide();this.allyraders[t].show();var a=Math.min(a,75),n=Math.atan2(i,s);this.allyraders[t].setPosition(SCREEN_WIDTH-100+Math.sin(n)*a,SCREEN_HEIGHT-100+Math.cos(n)*a)},this)},removeAlly:function(e){var t=this.get(e);t.parent.remove(t),THREE.applyToAllMaterial(t.material,function(e){e.dispose()}),this.remove(e),this.allyraders[e].remove(),this.allyraders.splice(e,1)},kill:function(e){var t=this.get(e);this.effectManager.explode(t.position,t.size,t.explodeTime),this.deathcount++,this.removeAlly(e)}}),phina.define("EnemyManager",{superClass:"SimpleUpdater",enemyraders:[],groups:[],killcount:0,allcount:0,init:function(e,t,i,s){this.superInit(),this.scene=e,this.threescene=t,this.gauge_boss_h=i,this.message=s},create:function(){this.allcount++,this._create.apply(this,arguments)},_create:function(e,t,i,s,a){if(a){var n=function(r){r.progress>a&&(this._create(e,t,i,s),this.off("frame",n))};this.on("frame",n)}else{if(!s){var r=UnitManager.get(e).mesh.get(!1,!0);THREE.$extend(r,UnitManager.get(e).routine),THREE.$extend(r,t),r.summons=this,r.group=i,this.threescene.add(r),this.elements.push(r);var o=phina.display.CircleShape({radius:3,fill:"hsla(0, 80%, 60%, 0.5)",stroke:"hsla(0, 0%, 0%, 0.5)",strokeWidth:1}).addChildTo(this.scene),l=this.player.position.x-r.position.x,h=this.player.position.z-r.position.z,c=Math.min(Math.sqrt(Math.pow(l,2)+Math.pow(h,2))/25,75),p=Math.atan2(l,h)-this.player.myrot.y+(Math.abs(this.player.myrot.x)>Math.PI/2&&Math.abs(this.player.myrot.x)<1.5*Math.PI?Math.PI:0);return o.setPosition(SCREEN_WIDTH-100+Math.sin(p)*c,SCREEN_HEIGHT-100+Math.cos(p)*c),this.enemyraders.push(o),r.stealth&&o.hide(),t.boss&&(this.scene.bosscoming=!0,this.scene.boss=r,this.gauge_boss_h.tweener.fadeIn(10).play(),this.gauge_boss_h.value=r.hp,this.gauge_boss_h.maxValue=r.hp),r}this.on("frame"+(this.scene.frame+s),this._create.bind(this,e,t,i))}},createMulti:function(e,t,i,s){var a=i.$safe(UnitManager.get(e).autospawn);this.groups.push({num:a.rep,message:s}),t.boss&&(this.scene.bossdefeated=!1);for(var n=0;n<a.rep;n++){var r={position:new THREE.Vector3};THREE.$extend(r,t),this.create(e,r,this.groups.last,a.time,a.progress),a.delay&&(a.time+=a.delay),THREE.$add(t,a.options),t.position.add(new THREE.Vector3(Math.random()*a.random.x*2-a.random.x,Math.random()*a.random.y*2-a.random.y,Math.random()*a.random.z*2-a.random.z))}},update:function(){this.each(function(e,t){if(this.opponents.bulletManager.hitTest(e),this.opponents.elements.each(function(t){e.position.clone().sub(t.position).length()<e.geometry.boundingSphere.radius+t.size&&(e===t.target&&t.targetAttacked(),e.hp-=Math.min(t.hp,2.5)/this.scene.difficulty*t.sharpness/e.armor,t.hp-=2.5*this.scene.difficulty*e.sharpness/t.armor)},this),e.update(this),e.despawn)return void this.removeEnemy(t);if(e.hp<=0)return void this.kill(t);e.time++;var i=this.player.position.x-e.position.x,s=this.player.position.z-e.position.z,a=Math.sqrt(Math.pow(i,2)+Math.pow(s,2))/25;if(e.stealth||a>100)return void this.enemyraders[t].hide();this.enemyraders[t].show();var a=Math.min(a,75),n=Math.atan2(i,s);this.enemyraders[t].setPosition(SCREEN_WIDTH-100+Math.sin(n)*a,SCREEN_HEIGHT-100+Math.cos(n)*a)},this)},removeEnemy:function(e){var t=this.get(e);if(t.group&&(t.group.num--,0===t.group.num&&t.group.message)){var i=t.group.message.text;t.group.message.offkill&&(this.message.text=""),""!==i&&(this.on("frame"+(this.scene.frame+(t.group.message.time-5)),function(){this.message.text=""}),this.on("frame"+(this.scene.frame+t.group.message.time),function(){this.message.text=i}))}this.player.targetingEnemy===t&&(this.player.way=null,this.player.targetingEnemy=null),t.parent.remove(t),THREE.applyToAllMaterial(t.material,function(e){e.dispose()}),this.remove(e),this.enemyraders[e].remove(),this.enemyraders.splice(e,1)},kill:function(e){this.effectManager.explode(this.get(e).position,this.get(e).size,this.get(e).explodeTime),this.scene.score+=this.get(e).size,this.killcount++,this.removeEnemy(e)}}),phina.define("UnitManager",{init:function(){console.error(this.className+" is static")},_static:{loadedunit:{},get:function(e){if(this.loadedunit[e])return this.loadedunit[e];if(this.loadedunit[e]={mesh:phina.asset.AssetManager.get("threejson",e),routine:this.units[e].routine.$safe({hp:5,armor:1,size:1,v:0,c:new THREE.Quaternion,time:0,sharpness:1,update:function(){}}),autospawn:(this.units[e].autospawn||{}).$safe({rep:1,options:{}})},!this.loadedunit[e].mesh)throw Error(e);return this.loadedunit[e].mesh.data.geometry.computeBoundingBox(),this.loadedunit[e].mesh.data.geometry.computeBoundingSphere(),this.loadedunit[e]},units:{enem1:{filename:"enem-1",routine:{v:.6,chase:0,firerate:100,mindist:0,aim:!1,weight:16,update:function(e){var t=e.player.position.clone().sub(this.position),i=(new THREE.Quaternion).setFromAxisAngle(Axis.z.clone().cross(t.clone().normalize()).normalize(),Math.acos(Axis.z.clone().dot(t.clone().normalize())));if(e.player.position.equals(this.position)||0===this.chase)this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v);else{var s=this.v*(0!==this.mindist?Math.clamp(2*(t.length()-this.mindist)/this.mindist,-1,1):1);this.quaternion.slerp(i,this.chase),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),s)}this.time%this.firerate===0&&e.bulletManager.createBullet("bullet",{position:this.position,quaternion:this.aim?i:this.quaternion,v:3.5,atk:7}),this.quaternion.premultiply(this.c)}},autospawn:{rep:6,delay:15}},enem2:{filename:"enem-2",routine:{hp:75,v:5,size:15,chase:.04,sharpness:2,firerate:15,explodeTime:30,weight:100,update:function(e){if(!e.player.position.equals(this.position)){var t=e.player.position.clone().sub(this.position);t.normalize(),this.quaternion.slerp((new THREE.Quaternion).setFromAxisAngle(Axis.z.clone().cross(t).normalize(),Math.acos(Axis.z.clone().dot(t))),this.chase),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v)}this.time%this.firerate===0&&e.bulletManager.createBullet("bullet",{position:this.position.clone().addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.geometry.boundingBox.max.z),quaternion:this.quaternion,v:6,size:1.5,atk:10})}}},enem3:{filename:"enem-3",routine:{hp:500,v:.25,size:30,firerate:1,r:.1,explodeTime:30,weight:250,scale:new THREE.Vector3(3,3,3),update:function(e){this.quaternion.premultiply(this.c),this.rotateZ(this.r),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v),this.time%this.firerate===0&&e.bulletManager.createBullet("bullet",{position:this.position,quaternion:this.quaternion.clone().rotate(Axis.x,.1+(Math.PI-.1)*(this.time%(8*this.firerate)/this.firerate/8)/20*(Math.random()+9)),v:2.5,size:.5,atk:5})}}},airballoon:{filename:"airballoon",routine:{hp:1e3,v:.2,size:40,firerate1:18,firerate2:33,explodeTime:45,weight:75,scale:new THREE.Vector3(2,2,2),update:function(e){this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v),this.time%this.firerate1===0&&(e.bulletManager.createBullet("bullet",{position:this.position.clone().add(new THREE.Vector3(7,0,24)),quaternion:this.quaternion.clone(),v:3,size:2.5,atk:15}),e.bulletManager.createBullet("bullet",{position:this.position.clone().add(new THREE.Vector3((-7),0,24)),quaternion:this.quaternion.clone(),v:3,size:2.5,atk:15})),this.time%this.firerate2===0&&(e.bulletManager.createBullet("bullet",{position:this.position.clone().add(new THREE.Vector3(10,(-10),20)),quaternion:this.quaternion.clone(),v:3,size:2.5,atk:15}),e.bulletManager.createBullet("bullet",{position:this.position.clone().add(new THREE.Vector3((-10),(-10),20)),quaternion:this.quaternion.clone(),v:3,size:2.5,atk:15})),this.time%this.firerate1===9&&(e.bulletManager.createBullet("bullet",{position:this.position.clone().add(new THREE.Vector3(10,0,10)),quaternion:this.quaternion.clone().rotateY(1),v:3,size:2.5,atk:15}),e.bulletManager.createBullet("bullet",{position:this.position.clone().add(new THREE.Vector3((-10),0,10)),quaternion:this.quaternion.clone().rotateY(-1),v:3,size:2.5,atk:15})),this.time%this.firerate2===11&&(e.bulletManager.createBullet("bullet",{position:this.position.clone().add(new THREE.Vector3(10,0,0)),quaternion:this.quaternion.clone().rotateY(1.57),v:3,size:2.5,atk:15}),e.bulletManager.createBullet("bullet",{position:this.position.clone().add(new THREE.Vector3((-10),0,0)),quaternion:this.quaternion.clone().rotateY(-1.57),v:3,size:2.5,atk:15})),this.time%this.firerate2===22&&(e.bulletManager.createBullet("bullet",{position:this.position.clone().add(new THREE.Vector3(10,0,(-20))),quaternion:this.quaternion.clone().rotateY(3),v:3,size:2.5,atk:15}),e.bulletManager.createBullet("bullet",{position:this.position.clone().add(new THREE.Vector3((-10),0,(-20))),quaternion:this.quaternion.clone().rotateY(-3),v:3,size:2.5,atk:15}))}}},blademinion:{filename:"slicer",routine:{hp:50,chase:.07,v:7.5,sharpness:3,size:5,explodeTime:30,stealth:!0,weight:25,scale:new THREE.Vector3(7,7,7),update:function(e){if(this.active){if(this.target.hp<=0||!this.target.parent){if(this.target===this.base.user)return void(this.despawn=!0);this.target=this.base.user}if(this.target===this.base.user&&this.target.position.clone().sub(this.position).length()<this.v&&(this.active=!1,this.base.cooldown=75),!this.target.position.equals(this.position)&&0!==this.chase){var t=this.target.position.clone().sub(this.position).normalize();this.quaternion.slerp((new THREE.Quaternion).setFromAxisAngle(Axis.z.clone().cross(t).normalize(),Math.acos(Axis.z.clone().dot(t))),this.chase)}this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v)}else this.hp=Math.min(this.hp+.01,50),this.base.user.hp<=0&&(this.hp=0),this.position.copy(this.base.user.position),this.quaternion.copy(this.base.user.quaternion);this.stealth=!this.active},targetAttacked:function(){this.target=this.base.user}}},assaultdrone:{filename:"assault",routine:{hp:10,chase:.07,v:6,bv:7,atk:8,sharpness:1.4,firerate:28,size:5,weight:16,mindist:50,explodeTime:20,expire:1/0,update:function(e){if(this.expire--,this.expire<=0)return void(this.despawn=!0);if((!this.target||this.target.hp<=0||!this.target.parent)&&(0!==e.opponents.elements.length&&(this.target=e.opponents.elements.reduce(function(e,t){
var i=t.position.clone().sub(this.position).length();return i<e.d?{d:i,enm:t}:e}.bind(this),{d:1/0,enm:null}).enm),!this.target))return void this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v);var t=this.target.position.clone().sub(this.position),i=(new THREE.Quaternion).setFromAxisAngle(Axis.z.clone().cross(t.clone().normalize()).normalize(),Math.acos(Axis.z.clone().dot(t.clone().normalize())));if(this.target.position.equals(this.position)||0===this.chase)this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v);else{var s=this.v*(0!==this.mindist?Math.clamp(2*(t.length()-this.mindist)/this.mindist,-1,1):1);this.quaternion.slerp(i,this.chase),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),s)}this.time%this.firerate===0&&e.bulletManager.createBullet("bullet",{position:this.position.clone().addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.geometry.boundingBox.max.z),quaternion:this.quaternion,v:this.bv,atk:this.atk})},targetAttacked:function(){}}}}}}),phina.define("BulletManager",{superClass:"SimpleUpdater",init:function(e,t,i){this.superInit(),this.scene=e,this.threescene=t,this.models={bullet:phina.asset.AssetManager.get("threejson","bullet").data,laser:new THREE.Mesh(new THREE.SphereGeometry(4,16,16),new THREE.ShaderMaterial({uniforms:{c:{type:"f",value:0},p:{type:"f",value:3},glowColor:{type:"c",value:new THREE.Color(16776960)}},vertexShader:phina.asset.AssetManager.get("text","glowvertexshader").data,fragmentShader:phina.asset.AssetManager.get("text","glowfragshader").data,side:THREE.FrontSide,transparent:!0}))},this.models.laser.scale.z=4,this.materials={bullet:[],laser:[]},this.cloneMaterial=i},createBullet:function(e,t,i){void 0===i&&(i=this.cloneMaterial);var s=this.models[e].deepclone(!1,i&&0===this.materials[e].length);return i&&0!==this.materials[e].length&&(s.material=this.materials[e].pop()),THREE.$extend(s,t).$safe({v:1,size:1,atk:1,ownMaterial:i,update:function(){this.position.add(this.velocity)}}),s.velocity=Axis.z.clone().applyQuaternion(s.quaternion).setLength(s.v),s.name=e,s.scale.multiplyScalar(2*s.size),this.threescene.add(s),this.elements.push(s),s},hitTest:function(e){this.each(function(t,i){e.position.clone().sub(t.position).length()<e.geometry.boundingSphere.radius*e.scale.x+t.size&&(e.summons.effectManager.explode(t.position,1,10),e.hp-=t.atk*this.scene.difficulty/e.armor,t.pierce||this.removeBullet(i))},this)},update:function(){this.each(function(e){e.update()})},removeBullet:function(e){var t=this.get(e);t.parent.remove(t),t.ownMaterial&&this.materials[t.name].push(t.material),this.remove(e)}}),phina.define("Skill",{init:function(e,t,i){this.user=e,this.scene=t,this.level=i},update:function(){},_static:{place:["core"],maxLevel:2,unlockedLevel:-1}}),phina.define("ActiveSkill",{superClass:"Skill",init:function(e,t,i){this.superInit(e,t,i),this.cooldown=0},update:function(){this.cooldown>0&&this.cooldown--},activate:function(){0===this.cooldown}}),phina.define("DeactivatableSkill",{superClass:"Skill",init:function(e,t,i){this.superInit(e,t,i),this.active=!1},activate:function(){this.active=!this.active}});var skills={};skills.byName={};var registerSkill=function(e){for(var t=e;void 0===t.unlockedLevel;)t=t.prototype.superClass;e.unlockedLevel=t.unlockedLevel,e.place.each(function(t){skills[t]||(skills[t]=[]),skills[t].push(e)}),skills.byName[e.prototype.className]=e};registerSkill(phina.define("Empty",{superClass:"Skill",init:function(){this.superInit()},_static:{skillName:"Uninstall",place:["top","core","front"],unlockedLevel:0,getDescription:function(e){return""}}})),registerSkill(phina.define("ExtraArmor",{superClass:"Skill",init:function(e,t,i){this.superInit(e,t,i),this.user.armor*=[1.175,1.19,1.205][i]},_static:{skillName:"Extra armor",place:["top","core"],unlockedLevel:0,getDescription:function(e){return"Reduce damage taken by "+[15,16,17][e]+"%."}}})),registerSkill(phina.define("Spear",{superClass:"Skill",init:function(e,t,i){this.superInit(e,t,i),this.user.sharpness*=[1.25,1.27,1.28][i]},_static:{skillName:"Spear",place:["front"],unlockedLevel:0,getDescription:function(e){return"Increase damage deal on\nhitting enemy directly by "+[25,27,28][e]+"%."}}})),registerSkill(phina.define("Acrobat",{superClass:"Skill",init:function(e,t,i){this.superInit(e,t,i),this.user.speed*=[1.2,1.213,1.22][i],this.user.rotspeed*=[1.3,1.32,1.33][i]},_static:{skillName:"Acrobat",place:["top","core"],unlockedLevel:0,getDescription:function(e){return"Greatly increase your mobility."}}})),registerSkill(phina.define("SelfRepair",{superClass:"DeactivatableSkill",init:function(e,t,i){this.superInit(e,t,i)},update:function(){if(this.active){var e=[50,70,100][this.level],t=Math.min([.01,.0125,.015][this.level],this.user.maxhp-this.user.hp,this.user.energy/e);this.user.energy-=t*e,this.user.hp+=t}},_static:{skillName:"Self repair",place:["top","core"],unlockedLevel:0,getDescription:function(e){return"With this skill, your HP is no\nlonger limited.\nHigher level one is faster but\nless energy efficient.\nCan toggle on/off by pushing activate key.\n"}}})),registerSkill(phina.define("ExtraGenerator",{superClass:"Skill",init:function(e,t,i){this.superInit(e,t,i)},update:function(){this.user.energy+=Math.min([.6,.63,.65][this.level],this.user.maxenergy-this.user.energy)},_static:{skillName:"Extra generator",place:["top","core"],unlockedLevel:0,getDescription:function(e){return"Allows you to use skills more by increasing energy\nreplenish speed."}}})),registerSkill(phina.define("Glitch",{superClass:"Skill",init:function(e,t,i){this.superInit(e,t,i),e.applyRotation=function(){this.rotateX(this.myrot.x),this.rotateY(this.myrot.y),this.rotateZ(this.myrot.z1+this.myrot.z2)}},_static:{skillName:"The glitch",place:["core"],getDescription:function(e){return"Do not use as this can completely break the game."}}})),registerSkill(phina.define("OverHeating",{superClass:"DeactivatableSkill",init:function(e,t,i){this.superInit(e,t,i),this.activated=!1;var s=this.user.getDamage;this.user.getDamage=function(e){return this.active?(this.activated||(this.activated=!0,this.user.hp-=[.02,.036,.056][i]),s(e)*[1.2,1.25,1.3][i]):s(e)}.bind(this)},update:function(){this.activated=!1},_static:{skillName:"Overheating",place:["top","core"],getDescription:function(e){return"Sacrifice your HP and increase firepower by "+[20,25,30]+"%.\nCan toggle on/off by pushing activate key."}}})),registerSkill(phina.define("Railgun",{superClass:"ActiveSkill",init:function(e,t,i){this.superInit(e,t,i)},update:function(){if(this.cooldown>0&&this.cooldown--,this.duration>0){this.duration--;Math.randfloat(0,2*Math.PI);this.scene.shakeScreen(8*this.duration),this.user.beam([36,45,50][this.level],3,25,0,this.scene)}},activate:function(){this.cooldown>0||(this.cooldown=this.user.consumeEnergy([150,250,320][this.level],function(){return this.duration=3,this.scene.effectManager.ray(this.user,[{color:16777215,opacity:.2,radius:1},{color:65535,opacity:.2,radius:2},{color:255,opacity:.2,radius:4}],7,function(e,t){return 1-e/t}),15}.bind(this),0))},_static:{skillName:"Railgun",place:["front"],unlockedLevel:1,getDescription:function(e){return"Shot deadly laser.\nProvides good firepower by\nconsuming large amount of\nenergy."}}})),registerSkill(phina.define("ParticleCannon",{superClass:"ActiveSkill",init:function(e,t,i){this.superInit(e,t,i)},update:function(){if(this.cooldown>0&&this.cooldown--,this.duration>0){this.duration--;Math.randfloat(0,2*Math.PI);this.scene.shakeScreen(this.duration),this.user.beam([10,12,15][this.level],2,15,[20,25,30][this.level],this.scene),0===this.duration&&(this.user.rotspeed*=[2,4,8][this.level])}if(this.delay>0&&(this.delay--,0===this.delay)){this.duration=[20,30,40][this.level];var e=new THREE.ShaderPass(phina.display.three.FadeShader);e.uniforms.color.value=new THREE.Vector4(1,1,1,.8),this.scene.app.composer.addPass(e);var t=this.scene.frame;this.scene.on("enterframe",function i(){this.scene.frame-t>1&&(this.scene.app.composer.passes.erase(e),this.scene.off("enterframe",i))}.bind(this)),this.scene.effectManager.ray(this.user,16777215,.5,500,2),this.scene.effectManager.ray(this.user,[{color:16777215,opacity:.2,radius:[5,6,8][this.level]},{color:16764108,opacity:.2,radius:[8,10,12][this.level]},{color:16746632,opacity:.2,radius:[12,15,18][this.level]},{color:16729156,opacity:.2,radius:[16,20,24][this.level]},{color:16711680,opacity:.2,radius:[20,25,30][this.level]}],[25,35,45][this.level],function(e,t){return e<4?2:e<6?.25:1-(e-6)/(t-6)})}},activate:function(e){!e||this.cooldown>0||(this.cooldown=this.user.consumeEnergy([1e3,1200,1600][this.level],function(){return this.delay=[5,8,12][this.level],this.user.rotspeed/=[2,4,8][this.level],this.scene.effectManager.ray(this.user,[{color:16777215,opacity:.8,radius:[3,3.75,5][this.level]}],this.delay,function(e,t){return e/t}),[250,300,400][this.level]}.bind(this),0))},_static:{skillName:"Particle cannon",place:["front"],getDescription:function(e){return"Powerful cannon that destroy "+(2===e?"":"almost ")+"anything front of it."}}})),registerSkill(phina.define("Lasergun",{superClass:"ActiveSkill",init:function(e,t,i){this.superInit(e,t,i)},activate:function(e){!e||this.cooldown>0||(this.cooldown=this.user.consumeEnergy([500,630,800][this.level],function(){return console.log(this.user.summons.bulletManager.createBullet("laser",{position:this.user.position.clone().addScaledVector(Axis.z.clone().applyQuaternion(this.user.quaternion).normalize(),this.user.geometry.boundingBox.max.z),quaternion:this.user.quaternion,v:18,atk:[60,70,75],pierce:!0})),[180,200,240][this.level]}.bind(this),0))},_static:{skillName:"Laser gun",place:["front"],unlockedLevel:0,getDescription:function(e){return"The Laser can pierce enemies.\nDeals massive damage\nagainst huge enemy by\nhitting their core."}}})),registerSkill(phina.define("BladeMinion",{superClass:"Skill",init:function(e,t,i){this.superInit(e,t,i),this.instance=this.user.summons.create("blademinion",{position:this.user.position.clone(),active:!1,stealth:!0,base:this,hp:[50,52,52][i],sharpness:[3,3.1,3.1][i]}),this.instance.material.color=new THREE.Color(1118481),i>=2&&(this.instance2=this.user.summons.create("blademinion",{position:this.user.position.clone(),active:!1,stealth:!0,base:this,hp:[50,52,52][i],sharpness:[3,3.1,3.1][i]}),this.instance2.material.color=new THREE.Color(1118481))},activate:function(e){if(e)return this.instance.active||this.level>=2&&this.instance2.active?(this.instance.target=this.user,void(this.instance2.target=this.user)):void(this.user.targetingEnemy&&this.user.consumeEnergy([280,280,600][this.level],function(){this.instance.active=!0,this.instance.target=this.user.targetingEnemy,this.level>=2?(this.instance2.active=!0,this.instance2.target=this.user.targetingEnemy,this.instance.quaternion.copy(this.user.quaternion).rotateY(.5),this.instance2.quaternion.copy(this.user.quaternion).rotateY(-.5)):this.instance.quaternion=this.user.quaternion.clone()}.bind(this)))},_static:{skillName:"Anti-material blade",usingModels:["blademinion"],place:["top"],getDescription:function(e){return"This blade will spawn out on\nactivation and automatically\nchase your enemy.\nCan pull back with pushing\nactivate key again."}}})),registerSkill(phina.define("Reinforce",{superClass:"ActiveSkill",init:function(e,t,i){this.superInit(e,t,i)},activate:function(){this.cooldown>0||(this.cooldown=this.user.consumeEnergy([200,750,1500][this.level],function(){var e=[2,4,6][this.level];return e.times(function(t){this.user.summons.create("assaultdrone",{position:this.user.position.clone().sub(Axis.z.clone().applyQuaternion(this.user.quaternion).setLength(500)).add(Axis.x.clone().applyQuaternion(this.user.quaternion).setLength(150*((e-1)/2-t))),quaternion:this.user.quaternion.clone(),expire:[2e3,1800,1500][this.level],hp:[8,10,11][this.level],chase:[.06,.07,.08][this.level],v:[5.6,6,6.3][this.level],sharpness:[1.2,1.4,1.5][this.level],firerate:[28,25,24][this.level],bv:[7,7.5,8][this.level],atk:[7,8,8.5][this.level]})},this),[2e3,2400,3e3][this.level]}.bind(this),0))},_static:{skillName:"Reinforce",usingModels:["assaultdrone"],place:["top","core"],unlockedLevel:0,getDescription:function(e){return"Larger fleet ascend you to the\nvictory."}}})),phina.define("ObstacleManager",{superClass:"SimpleUpdater",init:function(e){this.superInit(),this.threescene=e},create:function(e,t,i){var s=THREE.$extend(new THREE.Mesh(new THREE.BoxGeometry(i.x,i.y,i.z),new THREE.MeshPhongMaterial({color:"#888888"})),{position:e,quaternion:t,size:i});return this.threescene.add(s),this.elements.push(s),s},update:function(){},removeObstacle:function(e){this.get(e).parent.remove(this.get(e)),this.remove(e)}}),phina.define("WindManager",{superClass:"SimpleUpdater",time:0,flyerposy:0,init:function(e){this.superInit(),this.threescene=e},create:function(e,t){var i={v:.2,size:100,position:new THREE.Vector2,winds:[],update:function(){}}.$extend(e);i.mesh=THREE.$extend(new THREE.Mesh(new THREE.RingGeometry(i.size-.4,i.size,50,5),new THREE.MeshBasicMaterial({color:t,side:THREE.DoubleSide})),{position:new THREE.Vector3(i.position.x,0,i.position.y)});for(var s=-1e4*Math.sign(i.v);Math.abs(s)<=1e4;s+=300*i.v)i.winds.push(i.mesh.clone()),i.winds.last.rotateX(Math.PI/2),i.winds.last.position.y=this.flyerposy+s,this.threescene.add(i.winds.last);return this.elements.push(i),i},update:function(){this.each(function(e){this.time%30===0&&(e.winds.push(e.mesh.clone()),e.winds.last.rotateX(Math.PI/2),e.winds.last.position.y=this.flyerposy-1e4*Math.sign(e.v),this.threescene.add(e.winds.last)),e.winds.first&&e.winds.first.parent&&Math.abs(e.winds.first.position.y-this.flyerposy)>1e4&&e.winds.first.parent.remove(e.winds.first);for(var t=0;t<e.winds.length;t++)e.winds[t].position.y+=10*e.v}),this.time++},removeWind:function(e){this.get(e).winds.each(function(e){e.parent.remove(e)}),this.remove(e)}}),phina.define("LoadingScene",{superClass:"phina.display.DisplayScene",init:function(e){e=e||{},this.superInit(e);var t=phina.asset.AssetLoader(),i=0;this.label=phina.display.Label("Loading... "+Math.round(100*i)+"%").addChildTo(this),this.label.setPosition(this.gridX.center(),this.gridY.center()),t.onprogress=function(e){this.label.text="Loading... "+Math.round(100*e.progress)+"%"}.bind(this),t.load(e.assets).then(function(){this.label.tweener.to({alpha:0},200*this.label.alpha,"easeOutCubic").wait(500).call(function(){this.app.popScene()},this)}.bind(this))}}),phina.define("SplashLoadingScene",{superClass:"phina.display.DisplayScene",init:function(e){e=(e||{}).$safe(phina.game.SplashScene.defaults),this.superInit(e);var t=phina.asset.AssetLoader(),i=0,s=phina.asset.Texture();s.load(e.imageURL).then(function(){this.sprite=phina.display.Sprite(s).addChildTo(this),this.sprite.setPosition(this.gridX.center(),this.gridY.center()),this.sprite.alpha=0,this.sprite.tweener.to({alpha:1},200,"easeOutCubic").wait(1e3).call(function(){t.loaded||(this.label=phina.display.Label("Loading... "+Math.round(100*i)+"%").addChildTo(this),this.label.setPosition(this.gridX.center(),this.gridY.center()),this.label.alpha=0,this.label.tweener.to({alpha:1},200,"easeOutCubic"),t.onprogress=function(e){this.label.text="Loading... "+Math.round(100*e.progress)+"%"}.bind(this))},this).to({alpha:0},200,"easeOutCubic").call(function(){this.remove()})}.bind(this)),t.onprogress=function(e){i=e.progress},t.load(e.assets).then(function(){t.loaded=!0,this.label&&this.label.alpha>this.sprite.alpha?this.label.tweener.clear().to({alpha:0},200*this.label.alpha,"easeOutCubic").wait(500).call(function(){this.app.popScene()},this).play():this.sprite.tweener.wait(500).call(function(){this.app.popScene()},this).play()}.bind(this))}}),phina.define("fly.SceneLoadingScene",{superClass:"phina.display.DisplayScene",init:function(e){e=(e||{}).$safe(fly.SceneLoadingScene.defaults),this.superInit(e),this.options=e,this.loadprogress=0,this.loadfrequenry=0},load:function(e){this.label=phina.display.Label({text:"Loading... 0%",fill:"hsla(0, 0%, 0%, 0.6)",fontSize:15}).addChildTo(this).setPosition(SCREEN_CENTER_X,SCREEN_CENTER_Y);for(var t=0;t<e.length;t++)for(var i=0;i<e[t].length;i++)this.loadfrequenry++;var s=function(){n=[];for(var t=0;t<e[a].length;t++)phina.namespace(function(){var i=phina.util.Flow(e[a][t].bind(this));i.then(function(){this.label.text="Loading... "+ ++this.loadprogress/this.loadfrequenry*100+"%",this.loadprogress===this.loadfrequenry&&this.removeChild(this.label)}.bind(this)),n.push(i)}.bind(this))}.bind(this),a=0,n=[];for(s(),t=1;t<e.length;t++){var a=t;phina.util.Flow.all(n).then(s)}}}),phina.define("TitleScene",{superClass:"phina.display.ThreeScene",frame:0,init:function(e){this.superInit(e);var t=function(){var e=new THREE.ShaderPass(phina.display.three.FadeShader);this.app.composer.addPass(e);var t=new THREE.ShaderPass({uniforms:{tDiffuse:{value:null},strength:{value:0}},vertexShader:"varying vec2 vUv;void main() {vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}",fragmentShader:"uniform float strength;uniform sampler2D tDiffuse;varying vec2 vUv;const float nFrag=1.0/30.0;float rnd(vec3 scale,float seed){return fract(sin(dot(gl_FragCoord.stp+seed,scale))*43758.5453+seed);}void main(void){vec4 destColor=vec4(0.0);float random=rnd(vec3(12.9898,78.233,151.7182),0.0);float totalWeight=0.0;for(float i=0.0;i<=30.0;i++){float percent=(i+random)*nFrag;float weight=percent-percent*percent;destColor+=texture2D(tDiffuse,vUv-(vUv-vec2(0.5,0.5))*percent*strength*nFrag)*weight;totalWeight+=weight;}gl_FragColor=destColor/totalWeight;}"});this.app.composer.addPass(t),this.startframe=0;var s=function(){e.uniforms.color.value.w=.025*this.startframe,t.uniforms.strength.value=.4*this.startframe,40===this.startframe?this.exit(i):this.startframe++}.bind(this);this.on("enterframe",s)}.bind(this),i={};i.skills=JSON.parse(localStorage.getItem("skills-pre"))||[{klass:Railgun,level:0},{klass:Empty,level:0},{klass:Empty,level:0},{klass:SelfRepair,level:0}],i.skills.each(function(e){e.name&&(e.klass=skills.byName[e.name])});var s={title:{x:0,y:0,sub:[{type:"label",value:"Forever Flight",y:this.gridY.center(-3),size:64},{type:"label",value:"Click start",y:this.gridY.center(3),size:32},{type:"model",name:"player",value:phina.asset.AssetManager.get("threejson","fighter").get(),x:0,y:50,z:0},{type:"model",value:new THREE.Mesh(new THREE.CircleGeometry(1e4,100),new THREE.MeshBasicMaterial({map:phina.asset.AssetManager.get("threetexture","plane").get()})),x:0,y:1e4,z:0,init:function(e){e.rotateX(-Math.PI/2)}}]},main:{x:-500,y:-500,sub:[{type:"label",value:"Main Menu",y:this.gridY.center(-4),size:64},{type:"label",value:"Campaign",y:this.gridY.center(-2),size:32,link:"difficulty"},{type:"label",value:"Stage Select",y:this.gridY.center(-1),size:32,link:"stageselect"},{type:"label",value:"Ship Select",size:32,link:"shipselect"},{type:"label",value:"Free Play",y:this.gridY.center(1),size:32,link:"difficulty",callback:function(){i.stage="arcade"}},{type:"label",value:"How to play",y:this.gridY.center(2),size:32,link:"help"},{type:"label",value:"Settings",y:this.gridY.center(3),size:32,link:"setting"},{type:"label",value:"Credit",x:this.gridX.center(6),y:this.gridY.center(7),size:24,link:"credit"},{type:"label",value:"Back",y:this.gridY.center(5),size:32,link:"title"}]},help:{x:750,y:750,sub:[{type:"label",value:"How to play",x:this.gridX.center(),y:this.gridY.span(4.5),size:64},{type:"label",value:"Your airplane moves automatically",x:this.gridX.center(),y:this.gridY.center(1.5),size:18},{type:"label",value:"to direction of your mouse pointer",x:this.gridX.center(),y:this.gridY.center(2),size:18},{type:"label",value:">",x:this.gridX.center(6),y:this.gridY.center(),size:48,link:"help2"},{type:"label",value:"(1/5)",x:this.gridX.center(),y:this.gridY.center(2.75),size:18},{type:"label",value:"Main Menu",x:this.gridX.center(),y:this.gridY.span(11.5),size:32,link:"main"}]},help2:{x:0,y:750,sub:[{type:"label",value:"Speed-up by pressing your left mouse button",x:this.gridX.center(),y:this.gridY.center(1.5),size:18},{type:"label",value:"<",x:this.gridX.center(-6),y:this.gridY.center(),size:48,link:"help"},{type:"label",value:">",x:this.gridX.center(6),y:this.gridY.center(),size:48,link:"help3"},{type:"label",value:"(2/5)",x:this.gridX.center(),y:this.gridY.center(2.75),size:18},{type:"label",value:"Main Menu",x:this.gridX.center(),y:this.gridY.span(11.5),size:32,link:"main"}]},help3:{x:-750,y:750,sub:[{type:"label",value:"Press W/S key to up/down vertically",x:this.gridX.center(),y:this.gridY.center(1.5),size:18},{type:"label",value:"(any key in this help is default key bind)",x:this.gridX.center(),y:this.gridY.center(2),size:18},{type:"label",value:"<",x:this.gridX.center(-6),y:this.gridY.center(),size:48,link:"help2"},{type:"label",value:">",x:this.gridX.center(6),y:this.gridY.center(),size:48,link:"help4"},{type:"label",value:"(3/5)",x:this.gridX.center(),y:this.gridY.center(2.75),size:18},{type:"label",value:"Main Menu",x:this.gridX.center(),y:this.gridY.span(11.5),size:32,link:"main"}]},help4:{x:-1500,y:750,sub:[{type:"label",value:"Press space key to attack",x:this.gridX.center(),y:this.gridY.center(1.5),size:18},{type:"label",value:"<",x:this.gridX.center(-6),y:this.gridY.center(),size:48,link:"help3"},{type:"label",value:">",x:this.gridX.center(6),y:this.gridY.center(),size:48,link:"help5"},{type:"label",value:"(4/5)",x:this.gridX.center(),y:this.gridY.center(2.75),size:18},{type:"label",value:"Main Menu",x:this.gridX.center(),y:this.gridY.span(11.5),size:32,link:"main"}]},help5:{x:-2250,y:750,sub:[{type:"label",value:"A/D key and Shift key to use up to 4 kind of skill",x:this.gridX.center(),y:this.gridY.center(1.5),size:18},{type:"label",value:"<",x:this.gridX.center(-6),y:this.gridY.center(),size:48,link:"help4"},{type:"label",value:"(5/5)",x:this.gridX.center(),y:this.gridY.center(2.75),size:18},{type:"label",value:"Main Menu",x:this.gridX.center(),y:this.gridY.span(11.5),size:32,link:"main"}]},stageselect:{x:560,y:-250,sub:[{type:"label",value:"Stage Select",x:this.gridX.center(),y:this.gridY.span(4),size:64},{type:"label",value:"Main Menu",x:this.gridX.center(),y:this.gridY.span(12),size:32,link:"main"},{type:"model",name:"airballoon",value:phina.asset.AssetManager.get("threejson","airballoon").get(),x:0,y:0,z:0,init:function(e){e.rotate(new THREE.Vector3(1,(-1),(-1)).normalize(),1)}}]},shipselect:{x:0,y:0,z:-20,sub:[{type:"label",value:"Ship Select",x:this.gridX.center(),y:this.gridY.span(4),size:64},{type:"label",value:"(You cannot select ship in this version)",x:this.gridX.center(),y:this.gridY.span(5),size:20},{type:"label",value:"<",x:this.gridX.span(2),y:this.gridY.center(),size:64},{type:"label",value:">",x:this.gridX.span(14),y:this.gridY.center(),size:64},{type:"label",value:"Modify Ship",x:this.gridX.center(),y:this.gridY.span(10.5),size:32,link:"shipmodify"},{type:"label",value:"Main Menu",x:this.gridX.center(),y:this.gridY.span(12),size:32,link:"main"}]},shipmodify:{x:0,y:0,z:-40,sub:[{type:"label",value:"Ship Modify",x:this.gridX.center(),y:this.gridY.span(4),size:64},{type:"point",parent:"player",index:0,place:"front",x:2,y:5,z:20},{type:"point",parent:"player",index:1,place:"front",x:-2,y:5,z:20},{type:"point",parent:"player",index:2,place:"top",x:0,y:8,z:-5},{type:"point",parent:"player",index:3,place:"core",x:0,y:4.5,z:0},{type:"label",value:"Back",x:this.gridX.center(),y:this.gridY.span(11),size:32,link:"shipselect"},{type:"label",value:"Main Menu",x:this.gridX.center(),y:this.gridY.span(12),size:32,link:"main"}]},difficulty:{x:-1250,y:-1e3,sub:[{type:"label",value:"Difficulty",x:this.gridX.center(),y:this.gridY.span(5),size:64},{type:"label",value:"Easy",x:this.gridX.center(),y:this.gridY.span(7),size:32,callback:function(){i.difficulty=.8,t()}},{type:"label",value:"Normal",x:this.gridX.center(),y:this.gridY.span(8),size:32,callback:t},{type:"label",value:"Hard",x:this.gridX.center(),y:this.gridY.span(9),size:32,callback:function(){i.difficulty=1.25,t()}},{type:"label",value:"Back",x:this.gridX.center(),y:this.gridY.span(11),size:32,link:"main"},{type:"model",name:"enem1",value:phina.asset.AssetManager.get("threejson","enem1").get(),x:200,y:50,z:0,init:function(e){e.rotate(new THREE.Vector3(1,(-1),(-1)).normalize(),1)}},{type:"model",name:"enem1",value:phina.asset.AssetManager.get("threejson","enem1").get(),x:-250,y:-50,z:0,init:function(e){e.rotate(new THREE.Vector3(1,(-1),(-1)).normalize(),1)}},{type:"model",name:"enem1",value:phina.asset.AssetManager.get("threejson","enem1").get(),x:-280,y:160,z:40,init:function(e){e.rotate(new THREE.Vector3(1,(-1),(-1)).normalize(),1)}}]},setting:{x:-250,y:-1440,sub:[{type:"label",value:"Settings",x:this.gridX.center(),y:this.gridY.span(4),size:64},{type:"label",value:"KeyBinding",x:this.gridX.center(),y:this.gridY.center(-.5),size:32},{type:"label",value:"Sound Volume",x:this.gridX.center(),y:this.gridY.center(.5),size:32},{type:"label",value:"Back",x:this.gridX.center(),y:this.gridY.span(12),size:32,link:"main"}]},credit:{x:-5e3,y:-5e3,sub:[{type:"label",value:"Credit",x:this.gridX.center(),y:this.gridY.span(4),size:64},{type:"label",value:"Programing: axion014",x:this.gridX.center(),y:this.gridY.span(6),size:32},{type:"label",value:"Back",x:this.gridX.center(),y:this.gridY.span(12),size:32,link:"main"}]}},a=phina.display.ThreeLayer({x:SCREEN_CENTER_X,y:SCREEN_CENTER_Y,width:SCREEN_WIDTH,height:SCREEN_HEIGHT,antialias:!0}),n=new THREE.DirectionalLight(16777215,1);n.position.set(0,0,30),a.scene.add(n),a.scene.add(new THREE.AmbientLight(6316128)),a.renderer.setClearColor(6728430),a.scene.fog=new THREE.FogExp2(6728430,25e-5),a.camera.position.z=100;var r=0;a.update=function(e){r+="shipmodify"===this.position?.2:1,this.player.quaternion.copy(new THREE.Quaternion),this.player.rotateX(.25*Math.sin(.01*r)),this.player.rotateY(-Math.PI/2+.005*r),a.camera.position.tweener.update(e),a.camera.updateMatrixWorld(),c.each(function(e){e.material.opacity=1-Math.min(.1*Math.max(Math.abs(a.camera.position.z-e.position.z-50)-10,0),1)}),this.frame++}.bind(this),a.addChildTo(this);var o=.085,l=function(e,t,i){var s=phina.geom.Vector2(a.camera.position.x/o,a.camera.position.y/o).distance(phina.geom.Vector2(e,t)),n=Math.max(s/3,900),r=s>3e3?"easeInOutQuint":"easeInOutCubic";a.camera.position.tweener.to({x:-e*o,y:t*o,z:100+i},n,r).play()}.bind(this),h=function(){l(-500,-500,0),this.onpointstart=function(e){p.each(function(t){var i=t.position.clone().project(a.camera);Math.abs(e.pointer.x-(i.x+1)*e.pointer.width/2)<t.canvas.textWidth/2&&Math.abs(e.pointer.y-(1-i.y)*e.pointer.height/2)<t.canvas.textHeight/2&&Math.abs(a.camera.position.z-t.position.z-50)<1&&t.onclick.each(function(e){e()})})}}.bind(this),c=[],p=[],d=[],u=phina.display.RectangleShape({x:SCREEN_CENTER_X,y:SCREEN_CENTER_Y,stroke:null,fill:"#6668",width:this.gridX.span(12),height:this.gridY.span(12)});u.alpha=0;var f=this;s.forIn(function(e,t){t.z=t.z||0,t.sub.each(function(e){if("label"===e.type){e.$safe({x:this.gridX.center(),y:this.gridY.center()});var n=16,r=new THREE_text2d.SpriteText2D(e.value,{align:new THREE.Vector2(0,.5),fillStyle:"hsla(0, 0%, 0%, 0.6)",font:e.size*o*n+"px "+phina.display.Label.defaults.fontFamily});r.scale.set(1/n,1/n,1),a.scene.add(r),r.position.set((-t.x+e.x-SCREEN_CENTER_X)*o,(t.y-e.y+SCREEN_CENTER_Y)*o,t.z+50),r.material.opacity=1-Math.min(.1*Math.max(Math.abs(t.z)-10,0),1),r.onclick=[];var g=!1;e.link&&(g=!0,r.onclick.push(function(){l(s[e.link].x,s[e.link].y,s[e.link].z||0),"title"===e.link?this.one("enterframe",function(){this.onpointstart=h}.bind(this)):"shipmodify"===e.link?d.each(function(e){e.setInteractive(!0).show()}):d.each(function(e){e.setInteractive(!1).hide()}),this.position=e.link}.bind(this))),e.callback&&(g=!0,r.onclick.push(e.callback)),c.push(r),g&&p.push(r)}else if("model"===e.type){var m=function(e,i){i.each(function(i){e.add(i.value),i.value.position.set((-t.x+i.x)*o,(t.y-i.y)*o,t.z+i.z),i.init&&i.init(i.value),i.name&&(this[i.name]=i.value),i.childrens&&m(i.value,i.childrens)},this)}.bind(this);m(a.scene,[e])}else if("point"===e.type){var y=phina.createClass({superClass:phina.display.DisplayElement,init:function(e){this.superInit(e),this.data=e.data,this.hide(),MarkShape({stroke:"#4a4",width:48,height:48}).addChildTo(this),phina.display.CircleShape({fill:"#4a48",stroke:null,radius:16}).addChildTo(this)},update:function(){var e=f[this.data.parent].localToWorld(new THREE.Vector3(this.data.x,this.data.y,this.data.z)).project(a.camera);this.x=(e.x+1)*SCREEN_CENTER_X,this.y=(1-e.y)*SCREEN_CENTER_Y},onpointstart:function(){f.interactive=!1,d.each(function(e){e.interactive=!1}),u.children.each(function(e){e.interactive=!0}),u.target=this.data,u.addChildTo(f),u.tweener.fadeIn(250).play(),u.updateCurrent(i.skills[this.data.index].klass,i.skills[this.data.index].level)}});d.push(y({data:e}).addChildTo(this))}},this)},this),this.onpointstart=h,u.skill={},u.name=phina.display.Label({y:this.gridY.span(-3)}).addChildTo(u),u.description=phina.ui.LabelArea({width:this.gridX.span(6.8),height:this.gridY.span(2),y:this.gridY.span(-1),fontSize:18}).addChildTo(u),phina.display.Label({x:this.gridX.span(-4.5),y:this.gridY.span(-1),text:"<",fontSize:48}).addChildTo(u).on("pointstart",function(){var e=skills[u.target.place].indexOf(u.skill.klass);do var t=skills[u.target.place][0===e?e=skills[u.target.place].length-1:--e];while(t.unlockedLevel<0);u.updateCurrent(t,Math.min(u.skill.level,t.unlockedLevel))}),phina.display.Label({x:this.gridX.span(4.5),y:this.gridY.span(-1),text:">",fontSize:48}).addChildTo(u).on("pointstart",function(){var e=skills[u.target.place].indexOf(u.skill.klass);do var t=skills[u.target.place][e===skills[u.target.place].length-1?e=0:++e];while(t.unlockedLevel<0);u.updateCurrent(t,Math.min(u.skill.level,t.unlockedLevel))});var g=phina.display.Label({y:this.gridY.span(-4),text:"<",fontSize:48}).addChildTo(u).on("pointstart",function(){u.skill.level<u.skill.klass.unlockedLevel&&u.updateCurrent(u.skill.klass,u.skill.level+1)});g.rotation=90;var m=phina.display.Label({y:this.gridY.span(2),text:">",fontSize:48}).addChildTo(u).on("pointstart",function(){u.skill.level>0&&u.updateCurrent(u.skill.klass,u.skill.level-1)});m.rotation=90,u.ok=phina.display.Label({y:this.gridY.span(3.25),text:"Replace"}).addChildTo(u).on("pointstart",function(){i.skills[u.target.index]={klass:u.skill.klass,level:u.skill.level},i.skills.each(function(e){e.name=e.klass.prototype.className}),localStorage.setItem("skills-pre",JSON.stringify(i.skills)),u.close()}),phina.display.Label({y:this.gridY.span(4),text:"Back"}).addChildTo(u).on("pointstart",function(){u.close()}),u.close=function(){this.one("enterframe",function(){f.interactive=!0}),d.each(function(e){e.interactive=!0}),this.children.each(function(e){e.interactive=!1}),this.tweener.fadeOut(250).call(function(){this.target.remove()}).play()},u.updateCurrent=function(e,t){this.skill.klass=e,this.skill.level=t;var s=this.skill.klass!==i.skills[this.target.index].klass||this.skill.level!==i.skills[this.target.index].level;this.ok.setVisible(s).setInteractive(s),this.ok.text="Empty"===i.skills[this.target.index].klass.prototype.className?"Install":"Replace",this.ok.y=f.gridY.span(3.25),"Empty"===e.prototype.className?s?(this.name.text="",this.ok.text="Uninstall",this.ok.y=f.gridY.span(-1)):this.name.text="No module":this.name.text=e.skillName+" "+(t+1),this.description.text=e.getDescription(t)}}}),phina.define("MainScene",{superClass:"fly.SceneLoadingScene",frame:0,progress:0,score:0,goaled:!1,bossdefeated:!0,init:function(e){this.stage=e.stage||"arcade",this.difficulty=e.difficulty||1,this.space=e.space||!1,this.superInit();var t=phina.display.ThreeLayer({width:SCREEN_WIDTH,height:SCREEN_HEIGHT});t.setOrigin(0,0),this.threelayer=t;var i=phina.display.CircleShape({x:SCREEN_WIDTH-100,y:SCREEN_HEIGHT-100,radius:75,fill:"hsla(0, 0%, 30%, 0.5)",
stroke:null}),s=fly.DirectionShape({x:SCREEN_WIDTH-100,y:SCREEN_HEIGHT-100,fill:"hsla(0, 50%, 70%, 0.5)",stroke:"hsla(0, 0%, 0%, 0.5)",strokeWidth:1,width:2.5,height:4}),a=[],n=phina.ui.Gauge({x:80,y:SCREEN_HEIGHT-100,fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(255, 64, 64, 0.3)",value:1e3,maxValue:100,strokeWidth:1,width:128,height:16}),r=phina.ui.Gauge({x:80,y:SCREEN_HEIGHT-80,fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(64, 64, 255, 0.3)",value:2e3,maxValue:2e3,strokeWidth:1,width:128,height:16}),o=phina.ui.Gauge({x:this.gridX.center(),y:20,fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(200, 16, 16, 0.3)",strokeWidth:1,width:SCREEN_WIDTH/1.2,height:16}),l=phina.display.RectangleShape({y:SCREEN_HEIGHT,fill:"hsla(0, 0%, 30%, 0.5)",stroke:"hsla(0, 0%, 30%, 0.25)",strokeWidth:1,cornerRadius:5,width:SCREEN_WIDTH/5,height:SCREEN_HEIGHT/12}),h=phina.display.Label({y:SCREEN_HEIGHT,text:"",fontSize:16,fill:"hsla(0, 0%, 0%, 0.6)",align:"left"}),c=MarkShape({x:SCREEN_WIDTH-100,y:SCREEN_HEIGHT-100,width:30,height:30}),p=MarkShape({width:30,height:30}).hide(),d=fly.Popup({x:this.gridX.center(),y:this.gridY.center(),label:{text:"",fontSize:23,fill:"hsla(0, 0%, 0%, 0.8)"}}),u=[],f=[],g=phina.display.RectangleShape({x:this.gridX.center(),width:360,stroke:null}),m=phina.display.Label({x:this.gridX.center(),text:"Result",fontSize:48,fill:"hsla(0, 0%, 0%, 0.8)"}),y=phina.display.Label({x:this.gridX.center(),text:"",fontSize:24,fill:"hsla(0, 0%, 0%, 0.8)"}),E=AllyManager(this,t.scene),v=EnemyManager(this,t.scene,o,h),x=EffectManager(t.scene);E.effectManager=x,v.effectManager=x;var b=BulletManager(this,t.scene,!1),M=BulletManager(this,t.scene,!0);E.bulletManager=b,v.bulletManager=M,E.opponents=v,v.opponents=E;var T=ObstacleManager(t.scene),w=WindManager(t.scene),k=phina.asset.AssetManager.get("threejson","fighter").get(),R=new THREE.GridHelper(20400,100);this.load([[function(i){k.position.y=1e3,k.geometry.computeBoundingBox(),k.add(new THREE.AxesHelper(1e3)),k.tweener.setUpdateType("fps"),k.$safe({myrot:{x:0,y:0,z1:0,z2:0},pitch:0,yaw:0,v:5,av:new THREE.Vector3,maxenergy:2e3,maxhp:100,speed:.95,armor:1,rotspeed:1,sharpness:1,weight:100,summons:E,update:function(e,i,s){function a(e){return e%=2*Math.PI,e>Math.PI&&(e-=2*Math.PI),e<-Math.PI&&(e+=2*Math.PI),e}var o=Math.abs(this.myrot.x)>Math.PI/2;o?this.myrot.z2+=.05*(Math.PI-this.myrot.z2):this.myrot.z2*=.95,o=this.myrot.z2>Math.PI/2;var l=a(Math.atan2(e.y-SCREEN_CENTER_Y,e.x-SCREEN_CENTER_X)+this.myrot.y-this.yaw+(o?1.5*Math.PI:Math.PI/2)),h=(.04-.001*this.v)*this.rotspeed;if(Math.abs(l)>2.5?this.mode="back":("back"===this.mode&&(this.mode=null),l=Math.clamp(.07*l,-h,h),this.myrot.z1+=.3*l,this.yaw+=l),0!==v.elements.length)var c=v.elements.reduce(function(e,t){var i=t.position.clone().sub(this.position.clone().addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),5*this.v+25));i.y=0;var s=i.angleTo(Axis.z.clone().applyQuaternion((new THREE.Quaternion).rotateY(this.myrot.y-.5*this.yaw+("back"===this.mode!==o?Math.PI:0))));return s>Math.PI/("back"===this.mode?6:2)?e:(s*=i.length(),s<e.d?{d:s,enm:t}:e)}.bind(this),{d:1/0,enm:null}).enm;var d=i.getKey(16);if(this.way?(i.getKeyUp(87)||i.getKeyUp(83))&&(this.way=null):(i.getKeyDown(87)&&(this.way="up"),i.getKeyDown(83)&&(this.way="down")),this.targetingEnemy=c,c){p.show();var u=c.position.clone().project(t.camera);p.x=(u.x+1)*s.width/2,p.y=(1-u.y)*s.height/2,p.stroke="back"===this.mode?"#a44":"#444"}else p.hide();if(h/=2,this.position.y<100||"up"===this.way)this.pitch-=(o?-1:1)*h*("back"===this.mode?2:1-(o?(this.myrot.x+(this.myrot.x>0?-Math.PI:Math.PI))/1.6:-this.myrot.x/1.6));else if("down"===this.way)this.pitch+=(o?-1:1)*h*("back"===this.mode?2:1-(o?(-this.myrot.x-(this.myrot.x>0?-Math.PI:Math.PI))/1.6:this.myrot.x/1.6));else if(c){var f=c.position.clone().add(c.geometry.boundingSphere.center).sub(this.position),g="back"===this.mode!==o;l=a(Math.atan2(-f.y,Math.sqrt(f.x*f.x+f.z*f.z)*(g?-1:1))-this.myrot.x-this.pitch),this.pitch+=Math.clamp(.15*l,-h,h)}this.myrot.x+=.1*this.pitch,this.myrot.y-=.1*this.yaw,this.myrot.x=a(this.myrot.x),this.myrot.y=a(this.myrot.y),this.quaternion.copy(new THREE.Quaternion),this.applyRotation(),e.getPointing()&&this.consumeEnergy(3*this.speed,function(){s.space?this.av.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.speed):this.v+=this.speed}),s.space||(this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v),s.shakeScreen((this.v-5)/20)),this.position.add(this.av),this.myrot.z1*=.95,this.yaw*=.95-.1*(Math.PI/2-Math.abs(Math.abs(this.myrot.x)-Math.PI/2)),this.pitch*=.9,s.space?this.av.multiplyScalar(.996):(this.v*=.98-.06*(this.pitch+this.yaw),this.v<5&&(this.v=5),this.av.multiplyScalar(.98)),i.getKey(32)&&this.consumeEnergy(1.5,function(){this.attack(6),s.shakeScreen(2)}),this.sub.each(function(e){e.active!==!1&&e.update()}),i.getKey(65)&&opt(opt(this.sub,d?2:0),"activate")(i.getKeyDown(65)),i.getKey(68)&&opt(opt(this.sub,d?3:1),"activate")(i.getKeyDown(68)),this.energy=Math.min(this.energy+2,this.maxenergy),r.value=this.energy,n.value=this.hp,w.each(function(e){var t=15+e.size;Math.sqrt(this.position.x*e.position.x+this.position.z*e.position.y)<=t&&(this.av.y+=e.v/2)},this);for(var m=0;m<M.elements.length;m++)this.position.clone().sub(M.get(m).position).length()<5+M.get(m).size&&(s.shakeScreen(M.get(m).atk),this.hp-=M.get(m).atk*s.difficulty/this.armor,s.score--,M.removeBullet(m));v.elements.each(function(e){var t=Axis.z.clone().applyQuaternion(this.quaternion).setLength(this.geometry.boundingBox.getSize().z);fly.colcupsphere(this.position.clone().sub(t.clone().multiplyScalar(-.5)),t,e.position.clone().add(e.geometry.boundingSphere.center),this.geometry.boundingBox.max.x+e.geometry.boundingSphere.radius*e.scale.x)&&(s.shakeScreen(this.v),this.hp-=Math.min(e.hp,2.5)*s.difficulty*e.sharpness/this.armor,e.size<15&&(s.score--,this.v/=2),this.hp>0&&(e.hp-=this.v*this.sharpness/s.difficulty/e.armor))},this),T.each(function(e){fly.colobbsphere(e.position,this.position,e.size,e.quaternion,this.geometry.boundingBox.max.x)&&(this.hp=0)},this)},getDamage:function(e){return e},attack:function(e){var t=Math.random()*Math.PI*2;b.createBullet("bullet",{position:this.position.clone().add(Axis.z.clone().applyQuaternion(this.quaternion).normalize().multiplyScalar(this.geometry.boundingBox.max.z)),quaternion:this.quaternion.clone().rotate(new THREE.Vector3(Math.sin(t),Math.cos(t),0),Math.sqrt(9e-4*Math.random())),v:15,atk:this.getDamage(e)})},beam:function(e,t,i,s,a){var n=Axis.z.clone().applyQuaternion(this.quaternion).normalize();if(0===s)var r=new THREE.Raycaster(this.position.clone(),n).intersectObjects(v.elements);else for(var r=[],o=0;o<v.elements.length;o++)fly.colcupsphere(this.position.clone().add(n.clone().multiplyScalar(this.geometry.boundingBox.max.z+s)),n,v.get(o).position,s+5*v.get(o).size)&&r.push({point:v.get(o).position.clone(),object:v.get(o)});r.each(function(s){x.explode(s.point,t,i),s.object.hp-=this.getDamage(e)/a.difficulty},this)},consumeEnergy:function(e,t,i){return this.energy>=e?(this.energy-=e,t.call(this)):i},applyRotation:function(){this.rotateY(this.myrot.y),this.rotateX(this.myrot.x),this.rotateZ(this.myrot.z1+this.myrot.z2)}}),k.hp=k.maxhp,k.energy=k.maxenergy,E.player=k,v.player=k;var s=function(){k.sub=e.skills.map(function(e){return e.klass(k,this,e.level)},this),i()}.bind(this),a={threejson:{}},o=!1;e.skills.each(function(e){e.klass.usingModels&&e.klass.usingModels.each(function(e){o=!0,phina.asset.AssetManager.get("threejson",UnitManager.units[e].filename)||(a.threejson[e]="data/models/"+UnitManager.units[e].filename+".min.json")})}),o?phina.asset.AssetLoader().load(a).then(s):s()},function(e){if("arcade"!==this.stage){var t=function(){var t=phina.asset.AssetManager.get("stage",this.stage).get();d.label.text=t.name,t.enemys.each(function(e){v.createMulti(e.name,e.option,e.autospawn,e.killmes)}),t.obstacles.each(function(e){T.create(e.position,e.quaternion,e.scale)}),t.winds.each(function(e){w.create({v:e.v,position:e.position,size:e.size},e.color)}),t.messages.each(function(e){!e.progress||e.progress<1e-5?phina.namespace(function(){var t=e;this.on("frame"+(e.time-5),function(){h.text=""}),this.on("frame"+e.time,function(){h.text=t.text})}.bind(this)):phina.namespace(function(){var t=e,i=function(){t.progress<this.progress&&(this.on("frame"+(this.frame+t.time-5),function(){h.text=""}),this.on("frame"+(this.frame+t.time),function(){h.text=t.text}),this.off("enterframe",i))};this.on("enterframe",i,this)}.bind(this))},this),t.goals.each(function(e){phina.namespace(function(){var t=new THREE.ShaderMaterial({transparent:!0,uniforms:{tex1:{type:"t",value:phina.asset.AssetManager.get("threetexture","goal").get()},tex2:{type:"t",value:phina.asset.AssetManager.get("threetexture","goal_disable").get()},tex1_percentage:phina.app.Element().$safe({type:"f",value:0}).addChildTo(this),time:{type:"f",value:100*Math.random()},alpha:{type:"f",value:1}},vertexShader:phina.asset.AssetManager.get("text","goalvertexshader").data,fragmentShader:phina.asset.AssetManager.get("text","goalfragshader").data});u.push(new THREE.Mesh(new THREE.IcosahedronGeometry(e.size,2),t).$safe({size:e.size,kill:e.kill,message:e.message,enable:!1,update:function(e){t.uniforms.time.value+=.005*Math.random(),this.enable||this===u.first&&(this!==u.last||e.bossdefeated)&&v.killcount>=v.allcount*this.kill&&(t.uniforms.tex1_percentage.tweener.to({value:1},50).play(),f.first.fill="hsla(190, 100%, 70%, 0.5)",this.enable=!0)}})),t.uniforms.tex1_percentage.tweener.setUpdateType("fps"),u.last.move(new THREE.Vector3(e.x,e.y,e.z));var i=k.position.x/15-u.last.position.x/15,s=k.position.z/15-u.last.position.z/15,a=Math.min(Math.sqrt(Math.pow(i,2)+Math.pow(s,2)),75),n=Math.atan2(i,s)-k.myrot.y+(Math.abs(k.myrot.x)>Math.PI/2&&Math.abs(k.myrot.x)<1.5*Math.PI?Math.PI:0);f.push(phina.display.CircleShape({radius:5,fill:"hsla(0, 0%, 70%, 0.5)",stroke:"hsla(0, 0%, 0%, 0.5)",strokeWidth:1}).setPosition(SCREEN_WIDTH-100+Math.sin(n)*a,SCREEN_HEIGHT-100+Math.cos(n)*a))}.bind(this))},this),this.rate=t.rate,this.space=t.space,e()}.bind(this);if(phina.asset.AssetManager.get("stage",this.stage))t();else{var i=phina.asset.AssetLoader(),s={stage:{}};s.stage[this.stage]="data/stages/"+this.stage+".min.json",i.load(s).then(function(){var e=phina.asset.AssetManager.get("stage",this.stage).get();s={threejson:{}},0!==e.enemys.length?(e.enemys.each(function(e){phina.asset.AssetManager.get("threejson",e.name)||(s.threejson[e.name]="data/models/"+UnitManager.units[e.name].filename+".min.json")}),i.load(s).then(t)):t()}.bind(this))}}else{d.label.text="Free play";var s={threejson:{}};UnitManager.units.forIn(function(e,t){phina.asset.AssetManager.get("threejson",e)||(s.threejson[e]="data/models/"+t.filename+".min.json")}),phina.asset.AssetLoader().load(s).then(e)}}],[function(e){this.on("enter",function(){var e=new THREE.ShaderPass(phina.display.three.FadeShader);e.uniforms.color.value=new THREE.Vector4(1,1,1,1),this.app.composer.addPass(e),this.on("enterframe",function t(){40===this.frame?(this.app.composer.passes.erase(e),this.off("enterframe",t)):e.uniforms.color.value.w=1-.025*this.frame}.bind(this))}),t.addChildTo(this),i.addChildTo(this),s.addChildTo(this),s.rotation=180,d.fill="hsla(0, 0%, 50%, 0.5)",d.addChildTo(this),d.tweener2=phina.accessory.Tweener().attachTo(d),d.tweener.setUpdateType("fps"),d.tweener2.setUpdateType("fps"),d.tweener.set({width:0,height:72}).wait(10).to({width:720,height:3},100,"easeOutInCubic"),d.tweener2.set({alpha:0}).wait(10).fadeIn(30).wait(40).fadeOut(30);for(var u=0;u<4;u++)a[u]=fly.DirectionShape({x:SCREEN_WIDTH-100-75*Math.sin(u*Math.PI/2),y:SCREEN_HEIGHT-100-75*Math.cos(u*Math.PI/2),fill:"hsla(0, 0%, 10%, 0.5)",stroke:null,width:12,height:7.5}).addChildTo(this),a[u].rotation=90*-u;if(c.alpha=.5,c.addChildTo(this),p.alpha=.7,p.addChildTo(this),n.addChildTo(this),n.animation=!1,r.addChildTo(this),r.animation=!1,"arcade"!==this.stage){for(var u=0;u<f.length;u++)f[u].addChildTo(this);o.addChildTo(this),o.tweener.setUpdateType("fps"),o.alpha=0,o.animation=!1,l.addChildTo(this),l.live=0,h.addChildTo(this)}g.fill="hsla(0, 0%, 50%, 0.5)",g.addChildTo(this),m.addChildTo(this),y.addChildTo(this),g.tweener.setUpdateType("fps"),m.tweener.setUpdateType("fps"),y.tweener.setUpdateType("fps"),g.alpha=0,m.alpha=0,y.alpha=0,E.addChildTo(this),v.addChildTo(this),x.addChildTo(this),this.effectManager=x,b.addChildTo(this),M.addChildTo(this),w.addChildTo(this),e()},function(e){var i=new THREE.DirectionalLight(16777215,1);if(i.position.set(0,0,30),R.update=function(){this.position.x=k.position.x-k.position.x%200,this.position.z=k.position.z-k.position.z%200},"arcade"!==this.stage)for(var s=0;s<u.length;s++)u[s].tweener.setUpdateType("fps"),t.scene.add(u[s]);t.scene.add(i),t.scene.add(new THREE.AmbientLight(6316128)),t.scene.add(k),t.scene.add(R),t.camera.fov=100,t.camera.radiuses=[-100,10,28],t.camera.radius=0,t.camera.rotateY(Math.PI),t.camera.rotateX(-Math.PI/2),e()},function(e){t.update=function(e){function p(e){var t=1-Math.clamp(Math.abs(k.position.y-e.position.y)/A*5-4.5,0,1);THREE.applyToAllMaterial(e.material,function(e){e.opacity=.8*t+.2,e.transparent=1!==t})}var d=e.pointer,E=e.keyboard;if(k)if(this.goaled)k.flare("enterframe"),k.update(d,E,this),R.update(),t.camera.rotateAbsY(-.002);else{if("arcade"===this.stage){var T=Math.random();if(T>1-.01*this.difficulty&&v.count()<100){var S={position:new THREE.Vector3(Math.randint(-1e3,1e3),Math.randint(-100,100),Math.randint(-1e3,4e3)).add(k.position),quaternion:(new THREE.Quaternion).rotateY(Math.random()*Math.PI*2)},H=Slot([{weight:24,target:"enem1"},{weight:12,target:function(){return S.aim=!0,"enem1"}},{weight:8,target:"enem2"},{weight:4,target:"enem3"},{weight:3,target:"airballoon"}]);v.createMulti(H,S,{random:{x:50,y:10,z:50}})}this.difficulty+=1e-4,v.count()>50&&v.removeEnemy(0)}else{for(var z=0;z<u.length;z++){var C=(k.position.x-u[z].position.x)/25,_=(k.position.z-u[z].position.z)/25,I=Math.min(Math.sqrt(Math.pow(C,2)+Math.pow(_,2)),75),N=Math.atan2(C,_)-k.myrot.y+(Math.abs(k.myrot.x)>Math.PI/2&&Math.abs(k.myrot.x)<1.5*Math.PI?Math.PI:0);f[z].setPosition(SCREEN_WIDTH-100+Math.sin(N)*I,SCREEN_HEIGHT-100+Math.cos(N)*I),u[z].update(this)}this.progress=k.position.clone().dot(u.last.position)/u.last.position.clone().dot(u.last.position),v.flare("frame",{progress:this.progress})}if(this.frame%10===0){for(var z=0;z<b.elements.length;z++)b.get(z).position.clone().sub(k.position).length>800&&b.removeBullet(z);for(var z=0;z<M.elements.length;z++)M.get(z).position.clone().sub(k.position).length>800&&M.removeBullet(z)}if(b.count()>1050)for(;b.count()>1e3;)b.removeBullet(0);if(M.count()>1600)for(;M.count()>1550;)M.removeBullet(0);t.camera.position.copy(k.position.clone().add(new THREE.Vector3(0,650,(-200)))),t.camera.lookAt(k.position),this.flare("frame"+this.frame),v.flare("frame"+this.frame),k.flare("enterframe"),k.update(d,E,this),R.update(),w.playerposy=k.position.y,s.rotation=Math.radToDeg(-k.myrot.y)+(Math.abs(k.myrot.x)>Math.PI/2&&Math.abs(k.myrot.x)<1.5*Math.PI?0:180);var A=2*k.geometry.boundingBox.max.x;if(v.elements.each(p),M.elements.each(p),this.bosscoming&&(null===this.boss.parent?(this.bosscoming=!1,o.tweener.fadeOut(10).play(),this.bossdefeated=!0):o.value=this.boss.hp),E.getKeyDown(32)&&(h.text=""),k.hp<=0){if(x.explode(k.position,10,30),t.scene.remove(k),k=null,g.tweener.to({alpha:1,height:SCREEN_HEIGHT,y:SCREEN_CENTER_Y},5).play(),m.tweener.to({alpha:1,y:SCREEN_CENTER_Y/3},3).play(),y.tweener.wait(10).to({alpha:1,y:.6*SCREEN_CENTER_Y},3).play(),this.score<0&&(this.score=0),y.text="Score: "+this.score.toFixed(0)+"\nKill: "+v.killcount+"("+(v.killcount/v.allcount*100).toFixed(1)+"%)",m.text="Game Over",h.text="",i.tweener.fadeOut(20).play(),"arcade"!==this.stage)for(var z=0;z<f.length;z++)f[z].tweener.fadeOut(20).play();for(var z=0;z<v.count();z++)v.enemyraders[z].tweener.fadeOut(20).play();for(var z=0;z<4;z++)a[z].tweener.fadeOut(20).play();s.tweener.fadeOut(20).play(),n.tweener.fadeOut(20).play(),r.tweener.fadeOut(20).play(),l.tweener.fadeOut(20).play(),c.tweener.fadeOut(20).play()}else if("arcade"!==this.stage&&u.first.enable&&fly.colCup2D3(p1,u.first.position.clone(),v1,new THREE.Vector3(0,0,0),15+u.first.size/2))if(1===u.length){k.tweener.to({auto:1},60).play(),g.tweener.to({alpha:1,height:SCREEN_HEIGHT,y:SCREEN_CENTER_Y},5).play(),m.tweener.to({alpha:1,y:SCREEN_CENTER_Y/3},3).play(),y.tweener.wait(10).to({alpha:1,y:.6*SCREEN_CENTER_Y},3).play();var Y="";this.score+=this.rate[0]*k.hp/1e3,Y=this.score>=this.rate[3]?"Perfect":this.score>=this.rate[2]?"Good":this.score>=this.rate[1]?"Middle":"Bad",this.score<0&&(this.score=0),y.text="Score: "+this.score.toFixed(0)+(0!==v.allcount?"\nKill: "+v.killcount+"("+(v.killcount/v.allcount*100).toFixed(1)+"%)":"")+"\nLife: "+(k.hp/10).toFixed(1)+"%\nRate: "+Y,h.text="",i.tweener.fadeOut(20).play();for(var z=0;z<f.length;z++)f[z].tweener.fadeOut(20).play();for(var z=0;z<v.count();z++)v.enemyraders[z].tweener.fadeOut(20).play();for(var z=0;z<4;z++)a[z].tweener.fadeOut(20).play();s.tweener.fadeOut(20).play(),n.tweener.fadeOut(20).play(),r.tweener.fadeOut(20).play(),l.tweener.fadeOut(20).play(),c.tweener.fadeOut(20).play(),this.goaled=!0}else{var q=u.first.message;this.on("frame"+(this.frame+30),function(){h.text=q}.bind(this)),u.first.parent.remove(u.first),u.splice(0,1),f.first.remove(),f.splice(0,1)}this.frame%600===0&&this.score--,this.frame++}else t.camera.rotateAbsY(-.002);""!==h.text?l.live<.99999&&(l.live+=.5,l.setPosition(SCREEN_CENTER_X*l.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*l.live),l.width=SCREEN_WIDTH/10+SCREEN_WIDTH/1.3*l.live,l.height=SCREEN_HEIGHT/12+SCREEN_HEIGHT/8*l.live,h.setPosition(.2*SCREEN_CENTER_X*l.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*l.live)):l.live>1e-5&&(l.live-=.5,l.setPosition(SCREEN_CENTER_X*l.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*l.live),l.width=SCREEN_WIDTH/10+SCREEN_WIDTH/1.3*l.live,l.height=SCREEN_HEIGHT/12+SCREEN_HEIGHT/5*l.live,h.setPosition(.2*SCREEN_CENTER_X*l.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*l.live)),t.camera.updateMatrixWorld()}.bind(this),e()}]])},shakeScreen:function(e){var t=Math.randfloat(0,2*Math.PI);this.threelayer.camera.position.x+=Math.sin(t)*e,this.threelayer.camera.position.z+=Math.cos(t)*e}}),phina.define("MainSequence",{superClass:"phina.game.ManagerScene",init:function(){this.superInit({scenes:[{className:"LoadingScene",arguments:{lie:!1,assets:{threejson:{fighter:"data/models/fighter-1.min.json",bullet:"data/models/bullet-lq.min.json",enem1:"data/models/enem-1.min.json",airballoon:"data/models/airballoon.min.json"},threetexture:{plane:"data/images/3.png",explode:"data/images/explosion.png"},text:{expvertexshader:"data/glsl/expvertexshader.glsl",expfragshader:"data/glsl/expfragshader.glsl",glowvertexshader:"data/glsl/glowvertexshader.glsl",glowfragshader:"data/glsl/glowfragshader.glsl"}}}},{label:"title",className:"TitleScene",arguments:{width:SCREEN_WIDTH,height:SCREEN_HEIGHT}},{label:"main",className:"MainScene",arguments:{width:SCREEN_WIDTH,height:SCREEN_HEIGHT}}]})}}),phina.define("Application",{superClass:"phina.display.ThreeApp",init:function(){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,query:"#game",fit:!0}),threeext.extention(),this.replaceScene(MainSequence()),this.enableStats()}}),phina.main(function(){var e=Application();e.setupEffect().then(function(){e.run()})});