function Slot(e){for(var t=Math.random()*e.reduce(function(e,t){return e+t.weight},0),i=0,s=0;;s++)if(i+=e[s].weight,i>=t)return"function"==typeof e[s].target?e[s].target():e[s].target}phina.namespace(function(){var e=phina.display.Label.prototype.init;phina.display.Label.prototype.init=function(){e.apply(this,arguments),this.accessor("width",{get:phina.display.Label.prototype.calcCanvasWidth,set:function(e){}}),this.accessor("height",{get:phina.display.Label.prototype.calcCanvasHeight,set:function(e){}})}}),phina.define("phina.display.Screen",{superClass:"phina.display.RectangleShape",init:function(e){e=(e||{}).$safe({fill:null,backgroundColor:"transparent"}),this.superInit(e),this.scroll=phina.geom.Vector2(0,0),this.zoom=1},clip:function(e){e.beginPath(),e.setTransform(this._cr*this.scale.x,this._sr*this.scale.y,-this._sr*this.scale.x,this._cr*this.scale.y,this.position.x,this.position.y),e.rect(-this.width*this.origin.x,-this.height*this.origin.y,this.width,this.height)},_calcWorldMatrix:function(){if(this.parent){if(this.rotation!=this._cachedRotation){this._cachedRotation=this.rotation;var e=this.rotation*(Math.PI/180);this._sr=Math.sin(e),this._cr=Math.cos(e)}var t=this._matrix,i=this.parent._worldMatrix||phina.geom.Matrix33.IDENTITY,s=this._worldMatrix;t.m00=this._cr*this.scale.x*this.zoom,t.m01=-this._sr*this.scale.y*this.zoom,t.m10=this._sr*this.scale.x*this.zoom,t.m11=this._cr*this.scale.y*this.zoom;var a=-this.scroll.x*this.zoom*this.scale.x,n=-this.scroll.y*this.zoom*this.scale.y;t.m02=this.position.x-this.width*(this.origin.x-.5)+a*this._cr-n*this._sr,t.m12=this.position.y-this.height*(this.origin.y-.5)+a*this._sr+n*this._cr;var o=t.m00,r=t.m01,h=t.m02,l=t.m10,p=t.m11,c=t.m12,d=i.m00,u=i.m01,f=i.m02,m=i.m10,y=i.m11,g=i.m12;return s.m00=d*o+u*l,s.m01=d*r+u*p,s.m02=d*h+u*c+f,s.m10=m*o+y*l,s.m11=m*r+y*p,s.m12=m*h+y*c+g,this}},where:function(e){return Vector2((e.x-this.scroll.x)*this.zoom+this.width/2,(e.y-this.scroll.y)*this.zoom+this.height/2)},_accessor:{scrollX:{get:function(){return this.scroll.x},set:function(e){this.scroll.x=e}},scrollY:{get:function(){return this.scroll.y},set:function(e){this.scroll.y=e}}}});var SCREEN_WIDTH=640,SCREEN_HEIGHT=960,SCREEN_CENTER_X=SCREEN_WIDTH/2,SCREEN_CENTER_Y=SCREEN_HEIGHT/2,Axis={x:new THREE.Vector3(1,0,0).normalize(),y:new THREE.Vector3(0,1,0).normalize(),z:new THREE.Vector3(0,0,1).normalize()},threeext=threeext||{};threeext.$method("extention",function(){THREE.$method("$extend",function(e,t){var i=Array.prototype.slice.call(arguments);return i.shift(),Array.prototype.forEach.call(i,function(i){for(var s in i)e[s]&&t[s]&&t[s].className&&"THREE."===t[s].className.substr(0,6)?e[s].copy(t[s]):e[s]=t[s]},this),e}),THREE.$method("$add",function(e,t){var i=Array.prototype.slice.call(arguments);return i.shift(),Array.prototype.forEach.call(i,function(i){for(var s in i)t[s]||(e[s]&&t[s]&&t[s].className&&"THREE."===t[s].className.substr(0,6)?e[s].add(t[s]):e[s]+=t[s])},this),e}),THREE.$method("applyToAllMaterial",function(e,t){Array.isArray(e)?e.each(t):t(e)}),THREE.Object3D.prototype.$method("rotate",function(e,t,i){this.quaternion.rotate(e,t,i)}),THREE.Object3D.prototype.$method("move",function(e){return this.position.x=e.x,this.position.y=e.y,this.position.z=e.z,this}),THREE.Object3D.prototype.$method("rotateAbsX",function(e){this.quaternion.rotateAbsX(e)}),THREE.Object3D.prototype.$method("rotateAbsY",function(e){this.quaternion.rotateAbsY(e)}),THREE.Object3D.prototype.$method("rotateAbsZ",function(e){this.quaternion.rotateAbsZ(e)}),THREE.Mesh.prototype.$method("deepclone",function(e,t){return new this.constructor(e?this.geometry.clone():this.geometry,t?this.material.clone(!0):this.material).copy(this)}),THREE.Mesh.prototype.getter("tweener",function(){return this._tweener||(this._tweener=phina.accessory.Tweener().attachTo(this)),this._tweener}),function(){var e=["addEventListener","on","removeEventListener","off","clearEventListener","clear","hasEventListener","has","dispatchEvent","fire","dispatchEventByType","flare","attach","attachTo","detach"];e.each(function(e){THREE.Mesh.prototype.$method(e,phina.app.Element.prototype[e]),THREE.Vector3.prototype.$method(e,phina.app.Element.prototype[e])})}(),THREE.Mesh.prototype._listeners={},THREE.Vector3.prototype._listeners={},THREE.Vector3.prototype.className="THREE.Vector3",THREE.Quaternion.prototype.className="THREE.Quaternion",THREE.Quaternion.prototype.$method("rotate",function(e,t,i){return e&&this.rotateAbsX(e),t&&this.rotateAbsY(t),i&&this.rotateAbsZ(i),this}),THREE.Quaternion.prototype.$method("rotateX",function(e){return this.multiply((new THREE.Quaternion).setFromAxisAngle(Axis.x,e))}),THREE.Quaternion.prototype.$method("rotateY",function(e){return this.multiply((new THREE.Quaternion).setFromAxisAngle(Axis.y,e))}),THREE.Quaternion.prototype.$method("rotateZ",function(e){return this.multiply((new THREE.Quaternion).setFromAxisAngle(Axis.z,e))}),THREE.Quaternion.prototype.$method("rotateAbsX",function(e){return this.premultiply((new THREE.Quaternion).setFromAxisAngle(Axis.x,e))}),THREE.Quaternion.prototype.$method("rotateAbsY",function(e){return this.premultiply((new THREE.Quaternion).setFromAxisAngle(Axis.y,e))}),THREE.Quaternion.prototype.$method("rotateAbsZ",function(e){return this.premultiply((new THREE.Quaternion).setFromAxisAngle(Axis.z,e))}),THREE.Vector3.prototype.getter("tweener",function(){return this._tweener||(this._tweener=phina.accessory.Tweener().attachTo(this)),this._tweener}),THREE.MultiMaterial.prototype.accessor("opacity",{set:function(e){for(var t=0;t<this.materials.length;t++)this.materials[t].opacity=e},get:function(){return this.materials[0].opacity}})}),phina.define("fly.SimpleUpdater",{superClass:"phina.app.Element",init:function(){this.superInit(),this.elements=[]},update:function(){this.each(function(e){e.update()})},get:function(e){return this.elements[e]},remove:function(e){this.elements.splice(e,1)},count:function(e){return this.elements.length},each:function(e,t){this.elements.each(e,t)}}),phina.define("fly.DirectionShape",{superClass:"phina.display.Shape",init:function(e){e={}.$safe(e,{backgroundColor:"transparent",fill:"#ff5050",stroke:"#aaa",strokeWidth:2,width:16,height:32}),this.superInit(e)},prerender:function(e){e.beginPath().moveTo(0,this.height).lineTo(this.width,-this.height).lineTo(-this.width,-this.height).closePath()},initThreeMesh:function(){var e=new THREE.Group,t=new THREE.Shape;t.moveTo(0,-1),t.lineTo(1,1),t.lineTo(-1,1),t.lineTo(0,-1);var i=new THREE.ShapeGeometry(t);return e.fill=new THREE.Mesh(i,new THREE.MeshBasicMaterial),e.fill.position.z=1,e.stroke=new THREE.Mesh(i,new THREE.MeshBasicMaterial),e.add(e.stroke),e.add(e.fill),e},updateThreeMesh:function(e,t){function i(e,t,i){if(!t)return void(e.visible=!1);var s=phina.util.Color().setFromString(t);return s.a?(e.color=new THREE.Color(s.r/255,s.g/255,s.b/255),s.a*=void 0!==i?i:1,e.opacity=s.a,e.transparent=1!==s.a,void(e.visible=!0)):void(e.visible=!1)}i(e.fill.material,this.fill,t),e.fill.scale.set(this.width*this.scaleX,this.height*this.scaleY,1),i(e.stroke.material,this.stroke,t),e.stroke.scale.set((1+this.strokeWidth/this.width)*this.width*this.scaleX,(1+this.strokeWidth/this.height)*this.height*this.scaleY,1)}}),phina.define("MarkShape",{superClass:"phina.display.Shape",init:function(e){e={}.$safe(e,{backgroundColor:"transparent",stroke:"#444",strokeWidth:1,width:16,height:16}),this.superInit(e)},render:function(e){e.clearColor(this.backgroundColor),e.transformCenter(),this.isStrokable()&&(e.lineWidth=this.strokeWidth,e.strokeStyle=this.stroke,e.drawLine(-this.width,0,this.width,0),e.drawLine(0,-this.height,0,this.height))},initThreeMesh:function(){var e=new THREE.Group,t=new THREE.PlaneGeometry(1,1);return e.vertical=new THREE.Mesh(t,new THREE.MeshBasicMaterial),e.horizontal=new THREE.Mesh(t,new THREE.MeshBasicMaterial),e.add(e.vertical),e.add(e.horizontal),e},updateThreeMesh:function(e,t){function i(e,t,i){if(!t)return void(e.visible=!1);var s=phina.util.Color().setFromString(t);return s.a?(e.color=new THREE.Color(s.r/255,s.g/255,s.b/255),s.a*=void 0!==i?i:1,e.opacity=s.a,e.transparent=1!==s.a,void(e.visible=!0)):void(e.visible=!1)}i(e.vertical.material,this.stroke,t),e.vertical.scale.set(this.strokeWidth*this.scaleX,this.height*this.scaleY,1),i(e.horizontal.material,this.stroke,t),e.horizontal.scale.set(this.width*this.scaleX,this.strokeWidth*this.scaleY,1)}}),phina.define("fly.asset.ThreeJSON",{superClass:"phina.asset.Asset",data:null,init:function(){this.superInit()},_load:function(e){var t=this;(new THREE.JSONLoader).load(this.src,function(i,s){t.data=new THREE.Mesh(i,s),e(t)})},get:function(){return this.data.deepclone.apply(this.data,arguments)}}),phina.define("fly.asset.ThreeTexture",{superClass:"phina.asset.Asset",_asset:null,init:function(){this.superInit()},_load:function(e){var t=this;(new THREE.TextureLoader).load(this.src,function(i){t._asset=i,e(t)})},get:function(){var e=this._asset.clone();return e.needsUpdate=!0,e}}),phina.define("fly.asset.ThreeCubeTex",{superClass:"phina.asset.Asset",_asset:null,init:function(){this.superInit()},_load:function(e){var t=this,s=this.src.split(" ",2),a=[];for(i=0;i<6;i++)a[i]=s[0]+i+s[1];(new THREE.CubeTextureLoader).load(a,function(i){var s=THREE.ShaderLib.cube;s.uniforms.tCube.value=i,t._asset=new THREE.Mesh(new THREE.BoxGeometry(1e4,1e4,1e4),new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:s.uniforms,depthWrite:!1,side:THREE.BackSide})),e(t)})},get:function(){return this._asset.clone()}}),phina.define("fly.asset.Stage",{superClass:"phina.asset.Asset",data:{},init:function(){this.superInit()},_load:function(e){var t=this,i=phina.asset.File();i.load({path:this.src,dataType:"json"}).then(function(){var s=i.data;s.$safe({enemys:[],obstacles:[],winds:[],messages:[],goals:[]});for(var a=0;a<s.enemys.length;a++)s.enemys[a].$safe({position:{},rotation:{},option:{},autospawn:{},random:{},killmes:{}}),s.enemys[a].autospawn.$safe({time:0,progress:0,random:{}}),s.enemys[a].autospawn.random.$safe({x:0,y:0,z:0}),s.enemys[a].killmes.$safe({time:0,text:"",offkill:!1}),s.enemys[a].option.$safe({position:new THREE.Vector3(s.enemys[a].position.x||0,s.enemys[a].position.y||0,s.enemys[a].position.z||0),quaternion:(new THREE.Quaternion).rotate(s.enemys[a].rotation.x||0,s.enemys[a].rotation.y||0,s.enemys[a].rotation.z||0),c:(new THREE.Quaternion).rotate(s.enemys[a].rotation.cx||0,s.enemys[a].rotation.cy||0,s.enemys[a].rotation.cz||0)});for(var a=0;a<s.winds.length;a++)s.winds[a].$safe({v:.2,x:0,y:0,color:[0,0,0]}),s.winds[a].position=new THREE.Vector2(s.winds[a].x,s.winds[a].y),s.winds[a].c=s.winds[a].color[0]<<16|s.winds[a].color[1]<<8|s.winds[a].color[2];for(var a=0;a<s.obstacles.length;a++)s.obstacles[a].$safe({position:{},rotation:{},scale:{}}),s.obstacles[a].position=new THREE.Vector3(s.obstacles[a].position.x||0,s.obstacles[a].position.y||0,s.obstacles[a].position.z||0),s.obstacles[a].quaternion=(new THREE.Quaternion).rotate(s.obstacles[a].rotation.x||0,s.obstacles[a].rotation.y||0,s.obstacles[a].rotation.z||0),s.obstacles[a].scale=new THREE.Vector3(s.obstacles[a].scale.x||100,s.obstacles[a].scale.y||100,s.obstacles[a].scale.z||100);for(var a=0;a<s.messages.length;a++)s.messages[a].$safe({time:0,text:""});for(var a=0;a<s.goals.length;a++)s.goals[a].$safe({x:0,y:0,z:0,size:100,kill:0,message:""});this.data=s,e(t)}.bind(this))},get:function(){return this.data}}),phina.asset.AssetLoader.assetLoadFunctions.threejson=function(e,t){var i=fly.asset.ThreeJSON(),s=i.load(t);return s},phina.asset.AssetLoader.assetLoadFunctions.threetexture=function(e,t){var i=fly.asset.ThreeTexture(),s=i.load(t);return s},phina.asset.AssetLoader.assetLoadFunctions.threecubetex=function(e,t){var i=fly.asset.ThreeCubeTex(),s=i.load(t);return s},phina.asset.AssetLoader.assetLoadFunctions.stage=function(e,t){var i=fly.asset.Stage(),s=i.load(t);return s},fly.colCup2D3=function(e,t,i,s,a){var n=t.clone().sub(e),o=s.clone().multiplyScalar(i.clone().dot(s)/s.clone().dot(s)).sub(i),r=o.clone().dot(o);if(r<1e-5){var h=t.clone().sub(e).length();h=Math.min(h,t.clone().add(s).sub(e).length()),h=Math.min(h,t.clone().sub(e.clone().add(i)).length()),h=Math.min(h,t.clone().add(s).sub(e.clone().add(i)).length());var l=t.clone().add(s.multiplyScalar(n.clone().dot(s)/s.clone().dot(s)*-1)),p=Math.min(h,l.sub(e).length())}else var c=s.clone().dot(s),d=Math.clamp(o.clone().dot(n.clone().dot(s)/c*s.clone().sub(n))/r,0,1),u=Math.clamp(i.clone().multiplyScalar(d).sub(n).dot(s)/c,0,1),p=t.clone().add(s.clone().multiplyScalar(u)).sub(e.clone().add(i.clone().multiplyScalar(d))).length();return p<=a},fly.colcupsphere=function(e,t,i,s,a){var n=Math.max(i.clone().sub(e).dot(t),0);return a&&n>1&&(n=1),i.clone().sub(e.clone().addScaledVector(t,n)).length()<=s},fly.colobbsphere=function(e,t,i,s,a){var n=new THREE.Vector3(0,0,0),o=t.clone().sub(e);if(i.x>0){var r=Axis.x.clone().applyQuaternion(s),h=Math.abs(o.dot(r)/i.x);h>1&&n.add((1-h)*i.x*r)}return i.y>0&&(r=Axis.y.clone().applyQuaternion(s),h=Math.abs(o.dot(r)/i.y),h>1&&n.add((1-h)*i.y*r)),i.z>0&&(r=Axis.z.clone().applyQuaternion(s),h=Math.abs(o.dot(r)/i.z),h>1&&n.add((1-h)*i.z*r)),n.length()<=a},phina.define("fly.Popup",{superClass:"phina.display.Shape",init:function(e){e={}.$safe(e,{backgroundColor:"transparent",fill:"hsla(0, 0%, 0%, 0.6)",stroke:null,strokeWidth:2,width:512,height:48,sideIndent:32}),this.superInit(e),this.sideIndent=e.sideIndent,this.label=phina.display.Label(e.label).addChildTo(this)},prerender:function(e){var t=this.width/2,i=this.height/2;e.beginPath().moveTo(-t,-i).lineTo(this.sideIndent-t,0).lineTo(-t,i).lineTo(t,i).lineTo(t-this.sideIndent,0).lineTo(t,-i).closePath()},initThreeMesh:function(){var e=new THREE.Group,t=new THREE.Shape;t.moveTo(-1,-.5),t.lineTo(0,0),t.lineTo(-1,.5),t.lineTo(0,.5),t.lineTo(0,-.5),t.lineTo(-1,-.5);var i=new THREE.ShapeGeometry(t),s=new THREE.PlaneGeometry(1,1);return e.fill=new THREE.Mesh(s,new THREE.MeshBasicMaterial),e.fill.position.z=1,e.stroke=new THREE.Mesh(s,new THREE.MeshBasicMaterial),e.fillleft=new THREE.Mesh(i,new THREE.MeshBasicMaterial),e.fillleft.position.z=1,e.strokeleft=new THREE.Mesh(i,new THREE.MeshBasicMaterial),e.fillright=new THREE.Mesh(i,new THREE.MeshBasicMaterial({side:THREE.BackSide})),e.fillright.position.z=1,e.strokeright=new THREE.Mesh(i,new THREE.MeshBasicMaterial({side:THREE.BackSide})),e.add(e.stroke),e.add(e.fill),e.add(e.strokeleft),e.add(e.fillleft),e.add(e.strokeright),e.add(e.fillright),e},updateThreeMesh:function(e,t){function i(e,t,i){if(!t)return void(e.visible=!1);var s=phina.util.Color().setFromString(t);return s.a?(e.color=new THREE.Color(s.r/255,s.g/255,s.b/255),s.a*=void 0!==i?i:1,e.opacity=s.a,e.transparent=1!==s.a,void(e.visible=!0)):void(e.visible=!1)}var s=this.width-2*this.sideIndent;i(e.fill.material,this.fill,t),e.fill.scale.set(s*this.scaleX,this.height*this.scaleY,1),i(e.stroke.material,this.stroke,t),e.stroke.scale.set((1+this.strokeWidth/s)*s*this.scaleX,(1+this.strokeWidth/this.height)*this.height*this.scaleY,1),i(e.fillleft.material,this.fill,t),e.fillleft.scale.set(2*this.sideIndent*this.scaleX,this.height*this.scaleY,1),e.fillleft.position.x=-s*this.scaleX/2,i(e.strokeleft.material,this.stroke,t),e.strokeleft.scale.set((1+this.strokeWidth/this.sideIndent/2)*this.sideIndent*2*this.scaleX,(1+this.strokeWidth/this.height)*this.height*this.scaleY,1),e.strokeleft.position.x=-s*this.scaleX/2,i(e.fillright.material,this.fill,t),e.fillright.scale.set(2*-this.sideIndent*this.scaleX,this.height*this.scaleY,1),e.fillright.position.x=s*this.scaleX/2,i(e.strokeright.material,this.stroke,t),e.strokeright.scale.set(-(1+this.strokeWidth/this.sideIndent/2)*this.sideIndent*2*this.scaleX,(1+this.strokeWidth/this.height)*this.height*this.scaleY,1),e.strokeright.position.x=s*this.scaleX/2}}),phina.define("fly.EffectManager",{superClass:"fly.SimpleUpdater",init:function(e){this.superInit(),this.explodeManager=fly.ExplodeManager(e).addChildTo(this),this.rayManager=fly.RayManager(e).addChildTo(this),this.threescene=e},explode:function(e,t,i){return this.explodeManager.explode(e,t,i)},ray:function(e,t,i,s,a,n){return this.rayManager.ray(e,t,i,s,a,n)}}),phina.define("fly.ExplodeManager",{superClass:"fly.SimpleUpdater",init:function(e){this.superInit(),this.threescene=e},explode:function(e,t,i){var s=new THREE.ShaderMaterial({transparent:!0,uniforms:{tExplosion:{type:"t",value:phina.asset.AssetManager.get("threetexture","explode").get()},time:{type:"f",value:100*Math.random()},alpha:{type:"f",value:1}},vertexShader:phina.asset.AssetManager.get("text","expvertexshader").data,fragmentShader:phina.asset.AssetManager.get("text","expfragshader").data}),a=new THREE.Mesh(new THREE.IcosahedronGeometry(20,2),s).$safe({time:i,timeMax:i}).$safe({time:10,timeMax:10,update:function(){this.time--,s.uniforms.time.value+=.015*Math.random(),s.uniforms.alpha.value=this.time/this.timeMax}});return a.move(e),a.scale.set(t,t,t),this.threescene.add(a),this.elements.push(a),a},update:function(){for(var e=0;e<this.count();e++)this.get(e).update(),0===this.get(e).time&&(this.get(e).parent.remove(this.get(e)),this.remove(e),e--)}}),phina.define("fly.RayManager",{superClass:"fly.SimpleUpdater",init:function(e){this.superInit(),this.threescene=e},ray:function(e,t,i,s,a){e.geometry.boundingBox||e.geometry.computeBoundingBox();var n=this;if(a){var o=new THREE.Mesh(new THREE.SphereGeometry(s,20,10,0,2*Math.PI,0,Math.PI/2));o.position.y=500;var r=new THREE.Mesh(new THREE.CylinderGeometry(s,s,1e3,20,10),new THREE.MeshBasicMaterial({color:t,opacity:i,transparent:!0})).$safe({generator:e,offset:500+s+e.geometry.boundingBox.max.z,time:a,update:function(){return this.time--,0===this.time?(this.parent.remove(this),void n.elements.erase(this)):(this.move(this.generator.position.clone().add(Axis.z.clone().applyQuaternion(this.generator.quaternion).setLength(this.offset))),this.quaternion.copy(new THREE.Quaternion),this.rotate(Math.PI/2,Math.PI),void this.quaternion.premultiply(this.generator.quaternion))}});return r.geometry.mergeMesh(o),this.threescene.add(r),this.elements.push(r),r}var h=t,l=[];return l.$safe({generator:e,offset:500+h.reduce(function(e,t){return e>t.radius?e:t.radius},0)+e.geometry.boundingBox.max.z,time:0,timeMax:i,radiusfunc:s,update:function(){this.time++;var e=l.radiusfunc(this.time,this.timeMax);this.each(function(t){return this.time===this.timeMax?void t.parent.remove(t):(t.move(this.generator.position.clone().add(Axis.z.clone().applyQuaternion(this.generator.quaternion).setLength(this.offset))),t.quaternion.copy(new THREE.Quaternion),t.rotate(Math.PI/2,Math.PI),t.quaternion.premultiply(this.generator.quaternion),void(t.scale.x=t.scale.z=e))},this),this.time===this.timeMax&&n.elements.erase(this)}}),h.each(function(e){var t=new THREE.Mesh(new THREE.SphereGeometry(e.radius,20,10,0,2*Math.PI,0,Math.PI/2));t.position.y=500;var i=new THREE.Mesh(new THREE.CylinderGeometry(e.radius,e.radius,1e3,20,10),new THREE.MeshBasicMaterial({color:e.color,opacity:e.opacity,transparent:!0}));i.geometry.mergeMesh(t),this.threescene.add(i),l.push(i)},this),this.elements.push(l),l}}),phina.define("fly.EnemyManager",{superClass:"fly.SimpleUpdater",loadedenemy:[],enemyraders:[],groups:[],killcount:0,allcount:0,init:function(e,t,i,s){this.superInit(),this.scene=e,this.threescene=t,this.gauge_boss_h=i,this.message=s,this.effectmanager=fly.EffectManager(t).addChildTo(this)},loadEnemy:function(e){this.loadedenemy[e]={mesh:phina.asset.AssetManager.get("threejson",e),routine:this.enemys[e].routine.$safe({hp:5,size:1,v:0,c:new THREE.Quaternion,time:0,update:function(){}}),autospawn:(this.enemys[e].autospawn||{}).$safe({rep:1,options:{}})},this.loadedenemy[e].mesh.data.geometry.computeBoundingBox(),this.loadedenemy[e].mesh.data.geometry.computeBoundingSphere()},createEnemy:function(e,t,i,s,a){if(a){var n=function(o){o.progress>a&&(this.createEnemy(e,t,i,s),this.off("frame",n))};this.on("frame",n,this)}else{if(!s){var o=this.loadedenemy[e].mesh.get(!1,!0);THREE.$extend(o,this.loadedenemy[e].routine),THREE.$extend(o,t),o.group=i,this.threescene.add(o),this.elements.push(o);var r=phina.display.CircleShape({radius:3,fill:"hsla(0, 80%, 60%, 0.5)",stroke:"hsla(0, 0%, 0%, 0.5)",strokeWidth:1}).addChildTo(this.scene),h=(this.player.position.x-o.position.x)/25,l=(this.player.position.z-o.position.z)/25,p=Math.min(Math.sqrt(Math.pow(h,2)+Math.pow(l,2)),75),c=Math.atan2(h,l)-this.player.myrot.y+(Math.abs(this.player.myrot.x)>Math.PI/2&&Math.abs(this.player.myrot.x)<1.5*Math.PI?Math.PI:0);return r.setPosition(SCREEN_WIDTH-100+Math.sin(c)*p,SCREEN_HEIGHT-100+Math.cos(c)*p),this.enemyraders.push(r),t.boss&&(this.scene.bosscoming=!0,this.scene.boss=o,this.gauge_boss_h.tweener.fadeIn(10).play(),this.gauge_boss_h.value=o.hp,this.gauge_boss_h.maxValue=o.hp),o}this.on("frame"+(this.scene.frame+s),function(){this.createEnemy(e,t,i)}.bind(this))}},createEnemyMulti:function(e,t,i,s){var a=i.$safe(this.loadedenemy[e].autospawn);this.groups.push({num:a.rep,message:s}),t.boss&&(this.scene.bossdefeated=!1);for(var n=0;n<a.rep;n++){var o={position:new THREE.Vector3};THREE.$extend(o,t),this.createEnemy(e,o,this.groups.last,a.time,a.progress),a.delay&&(a.time+=a.delay),THREE.$add(t,a.options),t.position.add(new THREE.Vector3(Math.random()*a.random.x*2-a.random.x,Math.random()*a.random.y*2-a.random.y,Math.random()*a.random.z*2-a.random.z))}this.allcount+=a.rep},update:function(){for(var e=0;e<this.count();e++){this.get(e).update(this),this.get(e).time++;var t=(this.player.position.x-this.get(e).position.x)/25,i=(this.player.position.z-this.get(e).position.z)/25,s=Math.sqrt(Math.pow(t,2)+Math.pow(i,2));if(s>100)this.enemyraders[e].hide();else{this.enemyraders[e].show();var s=Math.min(s,75),a=Math.atan2(t,i);this.enemyraders[e].setPosition(SCREEN_WIDTH-100+Math.sin(a)*s,SCREEN_HEIGHT-100+Math.cos(a)*s),this.get(e).hp<=0&&(this.kill(e),e--)}}},removeEnemy:function(e){var t=this.get(e);if(t.group&&(t.group.num--,0===t.group.num&&t.group.message)){var i=t.group.message.text;t.group.message.offkill&&(this.message.text=""),""!==i&&(this.on("frame"+(this.scene.frame+(t.group.message.time-5)),function(){this.message.text=""}.bind(this)),this.on("frame"+(this.scene.frame+t.group.message.time),function(){this.message.text=i}.bind(this)))}this.player.targetingEnemy===t&&(this.player.way=null,this.player.targetingEnemy=null),t.parent.remove(t),THREE.applyToAllMaterial(t.material,function(e){e.dispose()}),this.remove(e),this.enemyraders[e].remove(),this.enemyraders.splice(e,1)},kill:function(e){this.effectmanager.explode(this.get(e).position,this.get(e).size,this.get(e).explodeTime),this.scene.score+=this.get(e).size,this.killcount++,this.removeEnemy(e)},enemys:{enem1:{filename:"enem-1",routine:{v:.6,chase:0,duration:100,mindist:0,aim:!1,update:function(e){var t=e.player.position.clone().sub(this.position.clone()),i=(new THREE.Quaternion).setFromAxisAngle(Axis.z.clone().cross(t.clone().normalize()).normalize(),Math.acos(Axis.z.clone().dot(t.clone().normalize())));if(e.player.position.equals(this.position)||0===this.chase)this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v);else{var s=this.v*(0!==this.mindist?Math.clamp(2*(t.length()-this.mindist)/this.mindist,-1,1):1);this.quaternion.slerp(i,this.chase),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),s)}this.time%this.duration===0&&e.enmBulletManager.createBullet({position:this.position,quaternion:this.aim?i:this.quaternion,v:3.5,atk:70}),this.quaternion.premultiply(this.c)}},autospawn:{rep:6,delay:15}},enem2:{filename:"enem-2",routine:{hp:45,v:5,size:15,chase:.04,duration:15,explodeTime:30,update:function(e){if(!e.player.position.equals(this.position)){var t=e.player.position.clone().sub(this.position.clone());t.normalize(),this.quaternion.slerp((new THREE.Quaternion).setFromAxisAngle(Axis.z.clone().cross(t).normalize(),Math.acos(Axis.z.clone().dot(t))),this.chase),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v)}this.time%this.duration===0&&e.enmBulletManager.createBullet({position:this.position.clone().addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.geometry.boundingBox.max.z),quaternion:this.quaternion,v:6,size:1.5,atk:100})}}},enem3:{filename:"enem-3",routine:{hp:500,v:.25,size:30,duration:1,r:.1,explodeTime:30,scale:new THREE.Vector3(2,2,2),update:function(e){this.quaternion.premultiply(this.c),this.rotateZ(this.r),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v),this.time%this.duration===0&&e.enmBulletManager.createBullet({position:this.position,quaternion:this.quaternion.clone().multiply((new THREE.Quaternion).setFromAxisAngle(Axis.x,.1+(Math.PI-.1)*(this.time%(8*this.duration)/this.duration/8)/20*(Math.random()+9))),v:2.5,size:.5,atk:50})}}}}}),phina.define("fly.BulletManager",{superClass:"fly.SimpleUpdater",init:function(e){this.superInit(),this.threescene=e,this.bullet=phina.asset.AssetManager.get("threejson","bullet")},createBullet:function(e){var t=this.bullet.get(!1,!0);return THREE.$extend(t,e).$safe({v:1,size:1,atk:1,update:function(){this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v)}}),t.scale.setScalar(2*t.size),this.threescene.add(t),this.elements.push(t),t},update:function(){this.each(function(e){e.update()})},removeBullet:function(e){this.get(e).parent.remove(this.get(e)),THREE.applyToAllMaterial(this.get(e).material,function(e){e.dispose()}),this.remove(e)}}),phina.define("fly.ObstacleManager",{superClass:"fly.SimpleUpdater",init:function(e){this.superInit(),this.threescene=e},createObstacle:function(e,t,i){var s=THREE.$extend(new THREE.Mesh(new THREE.BoxGeometry(i.x,i.y,i.z),new THREE.MeshPhongMaterial({color:"#888888"})),{position:e,quaternion:t,size:i});return this.threescene.add(s),this.elements.push(s),s},update:function(){},removeObstacle:function(e){this.get(e).parent.remove(this.get(e)),this.remove(e)}}),phina.define("fly.WindManager",{superClass:"fly.SimpleUpdater",time:0,flyerposy:0,init:function(e){this.superInit(),this.threescene=e},createWind:function(e,t){var i={v:.2,size:100,position:new THREE.Vector2,winds:[],update:function(){}}.$extend(e);i.mesh=THREE.$extend(new THREE.Mesh(new THREE.RingGeometry(i.size-.4,i.size,50,5),new THREE.MeshBasicMaterial({color:t,side:THREE.DoubleSide})),{position:new THREE.Vector3(i.position.x,0,i.position.y)});for(var s=-1e4*Math.sign(i.v);Math.abs(s)<=1e4;s+=300*i.v)i.winds.push(i.mesh.clone()),i.winds.last.rotate(Math.PI/2,0,0),i.winds.last.position.y=this.flyerposy+s,this.threescene.add(i.winds.last);return this.elements.push(i),i},update:function(){this.each(function(e){this.time%30===0&&(e.winds.push(e.mesh.clone()),e.winds.last.rotate(Math.PI/2,0,0),e.winds.last.position.y=this.flyerposy-1e4*Math.sign(e.v),this.threescene.add(e.winds.last)),e.winds.first&&e.winds.first.parent&&Math.abs(e.winds.first.position.y-this.flyerposy)>1e4&&e.winds.first.parent.remove(e.winds.first);for(var t=0;t<e.winds.length;t++)e.winds[t].position.y+=10*e.v}),this.time++},removeWind:function(e){this.get(e).winds.each(function(e){e.parent.remove(e)}),this.remove(e)}}),phina.define("LoadingScene",{superClass:"phina.display.DisplayScene",init:function(e){e=e||{},this.superInit(e);var t=phina.asset.AssetLoader(),i=0;this.label=phina.display.Label("Loading... "+Math.round(100*i)+"%").addChildTo(this),this.label.setPosition(this.gridX.center(),this.gridY.center()),t.onprogress=function(e){this.label.text="Loading... "+Math.round(100*e.progress)+"%"}.bind(this),t.load(e.assets).then(function(){this.label.tweener.to({alpha:0},200*this.label.alpha,"easeOutCubic").wait(500).call(function(){this.app.popScene()},this)}.bind(this))}}),phina.define("SplashLoadingScene",{superClass:"phina.display.DisplayScene",init:function(e){e=(e||{}).$safe(phina.game.SplashScene.defaults),this.superInit(e);var t=phina.asset.AssetLoader(),i=0,s=phina.asset.Texture();s.load(e.imageURL).then(function(){this.sprite=phina.display.Sprite(s).addChildTo(this),this.sprite.setPosition(this.gridX.center(),this.gridY.center()),this.sprite.alpha=0,this.sprite.tweener.to({alpha:1},200,"easeOutCubic").wait(1e3).call(function(){t.loaded||(this.label=phina.display.Label("Loading... "+Math.round(100*i)+"%").addChildTo(this),this.label.setPosition(this.gridX.center(),this.gridY.center()),this.label.alpha=0,this.label.tweener.to({alpha:1},200,"easeOutCubic"),t.onprogress=function(e){this.label.text="Loading... "+Math.round(100*e.progress)+"%"}.bind(this))},this).to({alpha:0},200,"easeOutCubic").call(function(){this.remove()})}.bind(this)),t.onprogress=function(e){i=e.progress},t.load(e.assets).then(function(){t.loaded=!0,this.label&&this.label.alpha>this.sprite.alpha?this.label.tweener.clear().to({alpha:0},200*this.label.alpha,"easeOutCubic").wait(500).call(function(){this.app.popScene()},this).play():this.sprite.tweener.wait(500).call(function(){this.app.popScene()},this).play()}.bind(this))}}),phina.define("fly.SceneLoadingScene",{superClass:"phina.display.DisplayScene",init:function(e){e=(e||{}).$safe(fly.SceneLoadingScene.defaults),this.superInit(e),this.options=e,this.loadprogress=0,this.loadfrequenry=0},load:function(e){this.label=phina.display.Label({text:"Loading... 0%",fill:"hsla(0, 0%, 0%, 0.6)",fontSize:15}).addChildTo(this).setPosition(SCREEN_CENTER_X,SCREEN_CENTER_Y);for(var t=0;t<e.length;t++)for(var i=0;i<e[t].length;i++)this.loadfrequenry++;var s=function(){n=[];for(var t=0;t<e[a].length;t++)phina.namespace(function(){var i=phina.util.Flow(e[a][t].bind(this));i.then(function(){this.label.text="Loading... "+ ++this.loadprogress/this.loadfrequenry*100+"%",this.loadprogress===this.loadfrequenry&&this.removeChild(this.label)}.bind(this)),n.push(i)}.bind(this))}.bind(this),a=0,n=[];for(s(),t=1;t<e.length;t++){var a=t;phina.util.Flow.all(n).then(s)}}}),phina.define("TitleScene",{superClass:"phina.display.ThreeScene",frame:0,init:function(e){this.superInit(e);var t=function(){var e=new THREE.ShaderPass(phina.display.three.FadeShader);this.app.composer.addPass(e);var t=new THREE.ShaderPass({uniforms:{tDiffuse:{value:null},strength:{value:0}},vertexShader:"varying vec2 vUv;void main() {vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}",fragmentShader:"uniform float strength;uniform sampler2D tDiffuse;varying vec2 vUv;const float nFrag=1.0/30.0;float rnd(vec3 scale,float seed){return fract(sin(dot(gl_FragCoord.stp+seed,scale))*43758.5453+seed);}void main(void){vec4 destColor=vec4(0.0);float random=rnd(vec3(12.9898,78.233,151.7182),0.0);float totalWeight=0.0;for(float i=0.0;i<=30.0;i++){float percent=(i+random)*nFrag;float weight=percent-percent*percent;destColor+=texture2D(tDiffuse,vUv-(vUv-vec2(0.5,0.5))*percent*strength*nFrag)*weight;totalWeight+=weight;}gl_FragColor=destColor/totalWeight;}"});this.app.composer.addPass(t),this.startframe=0;var s=function(){e.uniforms.color.value.w=.025*this.startframe,t.uniforms.strength.value=.4*this.startframe,40===this.startframe?this.exit({stage:i.stage,difficulty:i.difficulty}):this.startframe++}.bind(this);this.on("enterframe",s)}.bind(this),i={},s={title:{x:0,y:0,sub:[{type:"label",value:"Re:Flight",y:this.gridY.center(-3),size:64},{type:"label",value:"Click start",y:this.gridY.center(3),size:32},{type:"model",name:"player",value:phina.asset.AssetManager.get("threejson","fighter").get(),x:0,y:0,z:0},{type:"model",value:new THREE.Mesh(new THREE.CircleGeometry(1e4,100),new THREE.MeshBasicMaterial({map:phina.asset.AssetManager.get("threetexture","plane").get()})),x:0,y:-1e3,z:0,init:function(e){e.rotate(-Math.PI/2,0,0)}}]},main:{x:-500,y:-500,sub:[{type:"label",value:"Main Menu",y:this.gridY.center(-4),size:64},{type:"label",value:"Campaign",y:this.gridY.center(-2),size:32,link:"difficulty"},{type:"label",value:"Stage Select",
y:this.gridY.center(-1),size:32,link:"stageselect"},{type:"label",value:"Ship Select",size:32,link:"shipselect"},{type:"label",value:"Tutorial",y:this.gridY.center(1),size:32,link:"tutorial"},{type:"label",value:"Free Mode",y:this.gridY.center(2),size:32,link:"difficulty",callback:function(){i.stage="arcade"}},{type:"label",value:"Settings",y:this.gridY.center(3),size:32,link:"setting"},{type:"label",value:"Back",y:this.gridY.center(5),size:32,link:"title"}]},tutorial:{x:750,y:750,sub:[{type:"label",value:"Tutorial",x:this.gridX.center(),y:this.gridY.span(4.5),size:64},{type:"label",value:"Move",x:this.gridX.center(),y:this.gridY.span(6.5),size:32,callback:function(){i.stage="tutorial_move",t()}},{type:"label",value:"Attack",x:this.gridX.center(),y:this.gridY.span(7.5),size:32,callback:function(){i.stage="tutorial_attack",t()}},{type:"label",value:"Special",x:this.gridX.center(),y:this.gridY.span(8.5),size:32,callback:function(){i.stage="tutorial_special",t()}},{type:"label",value:"Space",x:this.gridX.center(),y:this.gridY.span(9.5),size:32,callback:function(){i.stage="tutorial_space",t()}},{type:"label",value:"Back",x:this.gridX.center(),y:this.gridY.span(11.5),size:32,link:"main"}]},stageselect:{x:500,y:-250,sub:[{type:"label",value:"Stage Select",x:this.gridX.center(),y:this.gridY.span(4),size:64},{type:"label",value:"Main Menu",x:this.gridX.center(),y:this.gridY.span(12),size:32,link:"main"}]},shipselect:{x:0,y:0,z:-30,sub:[{type:"label",value:"Ship Select",x:this.gridX.center(),y:this.gridY.span(4),size:64},{type:"label",value:"Main Menu",x:this.gridX.center(),y:this.gridY.span(12),size:32,link:"main"}]},difficulty:{x:-1e3,y:-750,sub:[{type:"label",value:"Difficulty",x:this.gridX.center(),y:this.gridY.span(5),size:64},{type:"label",value:"Easy",x:this.gridX.center(),y:this.gridY.span(7),size:32,callback:function(){i.difficulty=.8,t()}},{type:"label",value:"Normal",x:this.gridX.center(),y:this.gridY.span(8),size:32,callback:t},{type:"label",value:"Hard",x:this.gridX.center(),y:this.gridY.span(9),size:32,callback:function(){i.difficulty=1.25,t()}},{type:"label",value:"Back",x:this.gridX.center(),y:this.gridY.span(11),size:32,link:"main"}]},setting:{x:-250,y:-1250,sub:[{type:"label",value:"Settings",x:this.gridX.center(),y:this.gridY.span(4),size:64},{type:"label",value:"Credit",x:this.gridX.center(),y:this.gridY.span(8),size:32,link:"credit"},{type:"label",value:"Back",x:this.gridX.center(),y:this.gridY.span(12),size:32,link:"main"}]},credit:{x:-5e3,y:-5e3,sub:[{type:"label",value:"Credit",x:this.gridX.center(),y:this.gridY.span(4),size:64},{type:"label",value:"Programing: axion014",x:this.gridX.center(),y:this.gridY.span(6),size:32},{type:"label",value:"Back",x:this.gridX.center(),y:this.gridY.span(12),size:32,link:"setting"}]}},a=phina.display.ThreeLayer({x:SCREEN_CENTER_X,y:SCREEN_CENTER_Y,width:SCREEN_WIDTH,height:SCREEN_HEIGHT,antialias:!0}),n=new THREE.DirectionalLight(16777215,1);n.position.set(0,0,30),a.scene.add(n),a.scene.add(new THREE.AmbientLight(6316128)),a.renderer.setClearColor(6728430),a.scene.fog=new THREE.FogExp2(6728430,4e-4),a.camera.position.z=100,a.update=function(e){this.player.quaternion.copy(new THREE.Quaternion),this.player.rotateX(.25*Math.sin(.01*this.frame)),this.player.rotateY(-Math.PI/2+.005*this.frame),a.camera.position.tweener.update(e),a.camera.updateMatrixWorld(),l.each(function(e){e.material.opacity=1-Math.min(.1*Math.max(Math.abs(a.camera.position.z-e.position.z-50)-10,0),1)}),this.frame++}.bind(this),a.addChildTo(this);var o=.085,r=function(e,t,i){var s=phina.geom.Vector2(a.camera.position.x/o,a.camera.position.y/o).distance(phina.geom.Vector2(e,t)),n=Math.max(s/3,1e3),r=s>3e3?"easeInOutQuint":"easeInOutCubic";a.camera.position.tweener.to({x:-e*o,y:t*o,z:100+i},n,r).play()}.bind(this),h=function(){r(-500,-500,0),this.onpointstart=function(e){p.each(function(t){var i=t.position.clone().project(a.camera);Math.abs(e.pointer.x-(i.x+1)*e.pointer.width/2)<t.canvas.textWidth/2&&Math.abs(e.pointer.y-(1-i.y)*e.pointer.height/2)<t.canvas.textHeight/2&&Math.abs(a.camera.position.z-t.position.z-50)<1&&t.onclick.each(function(e){e()})})}}.bind(this),l=[],p=[];s.forIn(function(e,t){t.z=t.z||0,t.sub.each(function(e){if("label"===e.type){e.$safe({x:this.gridX.center(),y:this.gridY.center()});var i=16,n=new THREE_text2d.SpriteText2D(e.value,{align:new THREE.Vector2(0,.5),fillStyle:"hsla(0, 0%, 0%, 0.6)",font:e.size*o*i+"px "+phina.display.Label.defaults.fontFamily});n.scale.set(1/i,1/i,1),a.scene.add(n),n.position.set((-t.x+e.x-SCREEN_CENTER_X)*o,(t.y-e.y+SCREEN_CENTER_Y)*o,t.z+50),n.material.opacity=1-Math.min(.1*Math.max(Math.abs(t.z)-10,0),1),n.onclick=[];var c=!1;e.link&&(c=!0,n.onclick.push(function(){r(s[e.link].x,s[e.link].y,s[e.link].z||0),"title"===e.link&&this.one("enterframe",function(){this.onpointstart=h}.bind(this))}.bind(this))),e.callback&&(c=!0,n.onclick.push(e.callback)),l.push(n),c&&p.push(n)}else"model"===e.type&&(a.scene.add(e.value),e.value.position.set(e.x,e.y,e.z),e.init&&e.init(e.value),e.name&&(this[e.name]=e.value))},this)},this),this.onpointstart=h}}),phina.define("MainScene",{superClass:"fly.SceneLoadingScene",frame:0,progress:0,score:0,goaled:!1,bossdefeated:!0,init:function(e){this.stage=e.stage||"arcade",this.difficulty=e.difficulty||1,this.space=e.space||!1,this.superInit();var t=phina.display.ThreeLayer({width:SCREEN_WIDTH,height:SCREEN_HEIGHT});t.setOrigin(0,0);var i=phina.display.CircleShape({x:SCREEN_WIDTH-100,y:SCREEN_HEIGHT-100,radius:75,fill:"hsla(0, 0%, 30%, 0.5)",stroke:null}),s=fly.DirectionShape({x:SCREEN_WIDTH-100,y:SCREEN_HEIGHT-100,fill:"hsla(0, 50%, 70%, 0.5)",stroke:"hsla(0, 0%, 0%, 0.5)",strokeWidth:1,width:2.5,height:4}),a=[],n=phina.ui.Gauge({x:80,y:SCREEN_HEIGHT-100,fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(255, 64, 64, 0.3)",value:1e3,maxValue:1e3,strokeWidth:1,width:128,height:16}),o=phina.ui.Gauge({x:80,y:SCREEN_HEIGHT-80,fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(64, 64, 255, 0.3)",value:2e3,maxValue:2e3,strokeWidth:1,width:128,height:16}),r=phina.ui.Gauge({x:this.gridX.center(),y:20,fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(200, 16, 16, 0.3)",strokeWidth:1,width:SCREEN_WIDTH/1.2,height:16}),h=phina.display.RectangleShape({y:SCREEN_HEIGHT,fill:"hsla(0, 0%, 30%, 0.5)",stroke:"hsla(0, 0%, 30%, 0.25)",strokeWidth:1,cornerRadius:5,width:SCREEN_WIDTH/5,height:SCREEN_HEIGHT/12}),l=phina.display.Label({y:SCREEN_HEIGHT,text:"",fontSize:16,fill:"hsla(0, 0%, 0%, 0.6)",align:"left"}),p=MarkShape({x:SCREEN_WIDTH-100,y:SCREEN_HEIGHT-100,width:30,height:30}),c=MarkShape({width:30,height:30}).hide(),d=fly.Popup({x:this.gridX.center(),y:this.gridY.center(),label:{text:"",fontSize:23,fill:"hsla(0, 0%, 0%, 0.8)"}}),u=[],f=[],m=phina.display.RectangleShape({x:this.gridX.center(),width:360,stroke:null}),y=phina.display.Label({x:this.gridX.center(),text:"Result",fontSize:48,fill:"hsla(0, 0%, 0%, 0.8)"}),g=phina.display.Label({x:this.gridX.center(),text:"",fontSize:24,fill:"hsla(0, 0%, 0%, 0.8)"}),E=fly.EnemyManager(this,t.scene,r,l),v=E.effectmanager,T=fly.BulletManager(t.scene);E.enmBulletManager=T;var x=fly.ObstacleManager(t.scene),b=fly.WindManager(t.scene),w=phina.asset.AssetManager.get("threejson","fighter").get(),M=new THREE.GridHelper(20400,100);this.load([[function(e){w.position.y=1e3,w.geometry.computeBoundingBox(),w.add(new THREE.AxisHelper(1e3)),w.tweener.setUpdateType("fps"),w.$safe({myrot:{x:0,y:0,z1:0,z2:0},pitch:0,yo:0,v:0,s1c:0,s2c:0,e:2e3,hp:1e3,speed:.95,av:new THREE.Vector3,sub1id:0,sub2id:1,update:function(e,i,s){function a(e){return e%=2*Math.PI,e>Math.PI&&(e-=2*Math.PI),e<-Math.PI&&(e+=2*Math.PI),e}var r=Math.abs(this.myrot.x)>Math.PI/2&&Math.abs(this.myrot.x)<1.5*Math.PI;r?this.myrot.z2+=.05*(Math.PI-this.myrot.z2):this.myrot.z2*=.95;var h=Math.atan2(e.y-SCREEN_CENTER_Y,e.x-SCREEN_CENTER_X)+this.myrot.y-this.yo+Math.PI/2+(r?Math.PI:0);h=a(h);var l=.04-.001*this.v;if(Math.abs(h)>2.5?this.way="back":(h=Math.max(Math.min(.07*h,l),-l),this.myrot.z1+=8e-5*h,this.yo+=h),0!==E.elements.length)var p=E.elements.reduce(function(e,t){var i=t.position.clone().sub(this.position.clone().addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),5*this.v+25));i.y=0;var s=i.angleTo(Axis.z.clone().applyQuaternion((new THREE.Quaternion).rotateY(this.myrot.y+.5*this.yo+("back"===this.way?Math.PI:0))));return s>Math.PI/2?e:(s*=i.length(),s<e.d?{d:s,enm:t}:e)}.bind(this),{d:1/0,enm:null}).enm;if(p){c.show();var d=p.position.clone().project(t.camera);c.x=(d.x+1)*s.width/2,c.y=(1-d.y)*s.height/2}else c.hide();i.getKey(16);this.way?(i.getKeyUp(87)||i.getKeyUp(83)||"back"===this.way&&!p)&&(this.way=null):(i.getKeyDown(87)&&(this.way="up"),i.getKeyDown(83)&&(this.way="down"));var l=.02-5e-4*this.v;if(this.position.y<100||"up"===this.way)this.pitch-=l*(1.55-(r?1:-1)*this.myrot.x);else if("down"===this.way)this.pitch+=l*(1.55-(r?-1:1)*this.myrot.x);else if(p){var u=p.position.clone().add(p.geometry.boundingSphere.center).sub(this.position);h=Math.atan2(-u.y,Math.sqrt(u.x*u.x+u.z*u.z)*("back"===this.way&&Math.abs(Math.atan2(u.z,u.x)+this.myrot.y)>Math.PI?-1:1))-this.myrot.x-this.pitch,h>Math.PI&&(h-=2*Math.PI),h<-Math.PI&&(h+=2*Math.PI),this.pitch+=Math.clamp(.15*h,-l,l)}this.myrot.x+=.1*this.pitch,this.myrot.y-=.1*this.yo,this.myrot.x=a(this.myrot.x),this.myrot.y=a(this.myrot.y),this.quaternion.copy(new THREE.Quaternion),this.rotate(this.myrot.x,this.myrot.y),this.rotateZ(this.myrot.z1+this.myrot.z2),e.getPointing()&&this.consumeEnergy(this.speed,function(){s.space?this.av.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.speed):this.v+=this.speed}),s.space||this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v+5),this.position.add(this.av),this.myrot.z1*=.95,this.yo*=.95-.1*(Math.PI/2-Math.abs(Math.abs(this.myrot.x)-Math.PI/2)),this.pitch*=.9,s.space?this.av.multiplyScalar(.996):(this.v*=.98-.06*Math.abs(h),this.av.multiplyScalar(.98)),i.getKey(32)&&this.consumeEnergy(2,function(){var e=this.quaternion.clone();e.rotate(.06*Math.random()-.03,.06*Math.random()-.03);var t=this.quaternion.clone();t.rotate(.06*Math.random()-.03,.06*Math.random()-.03),this.attack(e,s),this.attack(t,s)}),this.s1c>0?this.s1c--:i.getKey(65)&&(this.s1c=this.sub[this.sub1id].call(this,s)),this.s2c>0?this.s2c--:i.getKey(68)&&(this.s2c=this.sub[this.sub2id].call(this,s)),this.rgl>0&&(this.rgl--,this.beam(35,2,15,0,s)),this.brl>0&&(this.brl--,this.beam(25,3,25,30,s)),this.e<2e3&&(this.e+=4),o.value=this.e,n.value=this.hp,b.each(function(e){var t=15+e.size;Math.sqrt(this.position.x*e.position.x+this.position.z*e.position.y)<=t&&(this.av.y+=e.v/2)},this);for(var f=0;f<T.elements.length;f++)this.position.clone().sub(T.get(f).position).length()<5+T.get(f).size&&(v.explode(T.get(f).position,T.get(f).size,10),this.hp-=T.get(f).atk*s.difficulty,s.score--,T.removeBullet(f));for(var f=0;f<E.elements.length;f++){var u=Axis.z.clone().applyQuaternion(this.quaternion).setLength(this.geometry.boundingBox.getSize().z);fly.colcupsphere(this.position.clone().sub(u.clone().multiplyScalar(-.5)),u,E.get(f).position.clone().add(E.get(f).geometry.boundingSphere.center),this.geometry.boundingBox.max.x+E.get(f).geometry.boundingSphere.radius)&&(v.explode(E.get(f).position,E.get(f).size,30),this.hp-=30*E.get(f).hp*s.difficulty/(this.v+5),s.score-=3,this.hp>0&&E.kill(f))}x.each(function(e){fly.colobbsphere(e.position,this.position,e.size,e.quaternion,this.geometry.boundingBox.max.x)&&(this.hp=0)},this)},sub:[function(){return this.consumeEnergy(250,function(){return this.rgl=2,v.ray(this,[{color:16777215,opacity:.2,radius:1},{color:65535,opacity:.2,radius:2},{color:255,opacity:.2,radius:4}],7,function(e,t){return 1-e/t}),20},0)},function(e){return this.consumeEnergy(1500,function(){this.brl=17;var t=new THREE.ShaderPass(phina.display.three.FadeShader);t.uniforms.color.value=new THREE.Vector4(1,1,1,.5),e.app.composer.addPass(t);var i=e.frame;return e.on("enterframe",function s(){e.frame-i>1&&(e.app.composer.passes.erase(t),e.off("enterframe",s))}),v.ray(this,16777215,.5,500,2),v.ray(this,[{color:16777215,opacity:.2,radius:8},{color:16764108,opacity:.2,radius:12},{color:16746632,opacity:.2,radius:18},{color:16729156,opacity:.2,radius:24},{color:16711680,opacity:.2,radius:30}],24,function(e,t){return e<2?2:e<4?.5:1-(e-4)/(t-4)}),250},0)}],attack:function(e,t){var i=new THREE.Raycaster;i.set(this.position.clone(),Axis.z.clone().applyQuaternion(e).normalize());var s=i.intersectObjects(E.elements);0!==s.length&&(v.explode(s[0].point,1,10),s[0].object.hp-=5/t.difficulty)},beam:function(e,t,i,s,a){var n=Axis.z.clone().applyQuaternion(this.quaternion).normalize();if(0===s)var o=new THREE.Raycaster(this.position.clone(),n).intersectObjects(E.elements);else for(var o=[],r=0;r<E.elements.length;r++)fly.colcupsphere(this.position.clone().add(n.clone().multiplyScalar(this.geometry.boundingBox.max.z+s)),n,E.get(r).position,s+5*E.get(r).size)&&o.push({point:E.get(r).position.clone(),object:E.get(r)});for(var r=0;r<o.length;r++)v.explode(o[r].point,t,i),o[r].object.hp-=e/a.difficulty},consumeEnergy:function(e,t,i){return this.e>=e?(this.e-=e,t.call(this)):i}}),E.player=w,e()}],[function(e){if("arcade"!==this.stage){var t=function(){var t=phina.asset.AssetManager.get("stage",this.stage).get();d.label.text=t.name,t.enemys.each(function(e){E.loadedenemy[e.name]||E.loadEnemy(e.name),E.createEnemyMulti(e.name,e.option,e.autospawn,e.killmes)}),t.obstacles.each(function(e){x.createObstacle(e.position,e.quaternion,e.scale)}),t.winds.each(function(e){b.createWind({v:e.v,position:e.position,size:e.size},e.color)}),t.messages.each(function(e){!e.progress||e.progress<1e-5?phina.namespace(function(){var t=e;this.on("frame"+(e.time-5),function(){l.text=""}),this.on("frame"+e.time,function(){l.text=t.text})}.bind(this)):phina.namespace(function(){var t=e,i=function(){t.progress<this.progress&&(this.on("frame"+(this.frame+t.time-5),function(){l.text=""}),this.on("frame"+(this.frame+t.time),function(){l.text=t.text}),this.off("enterframe",i))};this.on("enterframe",i,this)}.bind(this))},this),t.goals.each(function(e){phina.namespace(function(){var t=new THREE.ShaderMaterial({transparent:!0,uniforms:{tex1:{type:"t",value:phina.asset.AssetManager.get("threetexture","goal").get()},tex2:{type:"t",value:phina.asset.AssetManager.get("threetexture","goal_disable").get()},tex1_percentage:phina.app.Element().$safe({type:"f",value:0}).addChildTo(this),time:{type:"f",value:100*Math.random()},alpha:{type:"f",value:1}},vertexShader:phina.asset.AssetManager.get("text","goalvertexshader").data,fragmentShader:phina.asset.AssetManager.get("text","goalfragshader").data});u.push(new THREE.Mesh(new THREE.IcosahedronGeometry(e.size,2),t).$safe({size:e.size,kill:e.kill,message:e.message,enable:!1,update:function(e){t.uniforms.time.value+=.005*Math.random(),this.enable||this===u.first&&(this!==u.last||e.bossdefeated)&&E.killcount>=E.allcount*this.kill&&(t.uniforms.tex1_percentage.tweener.to({value:1},50).play(),f.first.fill="hsla(190, 100%, 70%, 0.5)",this.enable=!0)}})),t.uniforms.tex1_percentage.tweener.setUpdateType("fps"),u.last.move(new THREE.Vector3(e.x,e.y,e.z));var i=w.position.x/15-u.last.position.x/15,s=w.position.z/15-u.last.position.z/15,a=Math.min(Math.sqrt(Math.pow(i,2)+Math.pow(s,2)),75),n=Math.atan2(i,s)-w.myrot.y+(Math.abs(w.myrot.x)>Math.PI/2&&Math.abs(w.myrot.x)<1.5*Math.PI?Math.PI:0);f.push(phina.display.CircleShape({radius:5,fill:"hsla(0, 0%, 70%, 0.5)",stroke:"hsla(0, 0%, 0%, 0.5)",strokeWidth:1}).setPosition(SCREEN_WIDTH-100+Math.sin(n)*a,SCREEN_HEIGHT-100+Math.cos(n)*a))}.bind(this))},this),this.rate=t.rate,this.space=t.space,e()}.bind(this);if(phina.asset.AssetManager.get("stage",this.stage))t();else{var i=phina.asset.AssetLoader(),s={stage:{}};s.stage[this.stage]="data/stages/"+this.stage+".min.json",i.load(s).then(function(){var e=phina.asset.AssetManager.get("stage",this.stage).get();s={threejson:{}},0!==e.enemys.length?(e.enemys.each(function(e){phina.asset.AssetManager.get("threejson",e.name)||(s.threejson[e.name]="data/models/"+E.enemys[e.name].filename+".min.json")}),i.onload=t,i.load(s)):t()}.bind(this))}}else{d.label.text="Free play";var i=phina.asset.AssetLoader(),s={threejson:{}};E.enemys.forIn(function(e,t){phina.asset.AssetManager.get("threejson",e)||(s.threejson[e]="data/models/"+t.filename+".min.json")}),i.load(s).then(function(){E.enemys.forIn(function(e){E.loadedenemy[e]||E.loadEnemy(e)})}.bind(this)),e()}}],[function(e){this.on("enter",function(){var e=new THREE.ShaderPass(phina.display.three.FadeShader);e.uniforms.color.value=new THREE.Vector4(1,1,1,1),this.app.composer.addPass(e),this.on("enterframe",function t(){40===this.frame?(this.app.composer.passes.erase(e),this.off("enterframe",t)):e.uniforms.color.value.w=1-.025*this.frame}.bind(this))}),t.addChildTo(this),i.addChildTo(this),s.addChildTo(this),s.rotation=180,d.fill="hsla(0, 0%, 50%, 0.5)",d.addChildTo(this),d.tweener2=phina.accessory.Tweener().attachTo(d),d.tweener.setUpdateType("fps"),d.tweener2.setUpdateType("fps"),d.tweener.set({width:0,height:72}).wait(10).to({width:720,height:3},100,"easeOutInCubic"),d.tweener2.set({alpha:0}).wait(10).fadeIn(30).wait(40).fadeOut(30);for(var u=0;u<4;u++)a[u]=fly.DirectionShape({x:SCREEN_WIDTH-100-75*Math.sin(u*Math.PI/2),y:SCREEN_HEIGHT-100-75*Math.cos(u*Math.PI/2),fill:"hsla(0, 0%, 10%, 0.5)",stroke:null,width:12,height:7.5}).addChildTo(this),a[u].rotation=90*-u;if(p.alpha=.5,p.addChildTo(this),c.alpha=.7,c.addChildTo(this),n.addChildTo(this),n.animation=!1,o.addChildTo(this),o.animation=!1,"arcade"!==this.stage){for(var u=0;u<f.length;u++)f[u].addChildTo(this);r.addChildTo(this),r.tweener.setUpdateType("fps"),r.alpha=0,r.animation=!1,h.addChildTo(this),h.live=0,l.addChildTo(this)}m.fill="hsla(0, 0%, 50%, 0.5)",m.addChildTo(this),y.addChildTo(this),g.addChildTo(this),m.tweener.setUpdateType("fps"),y.tweener.setUpdateType("fps"),g.tweener.setUpdateType("fps"),m.alpha=0,y.alpha=0,g.alpha=0,E.addChildTo(this),T.addChildTo(this),b.addChildTo(this),e()},function(e){var i=new THREE.DirectionalLight(16777215,1);if(i.position.set(0,0,30),M.update=function(){this.position.x=w.position.x-w.position.x%200,this.position.z=w.position.z-w.position.z%200},"arcade"!==this.stage)for(var s=0;s<u.length;s++)u[s].tweener.setUpdateType("fps"),t.scene.add(u[s]);t.scene.add(i),t.scene.add(new THREE.AmbientLight(6316128)),t.scene.add(w),t.scene.add(M),t.camera.fov=100,t.camera.radiuses=[-100,10,28],t.camera.radius=0,t.camera.rotate(-Math.PI/2,Math.PI),e()},function(e){t.update=function(e){function c(e){var t=1-Math.clamp(Math.abs(w.position.y-e.position.y)/k*5-4.5,0,1);THREE.applyToAllMaterial(e.material,function(e){e.opacity=.8*t+.2,e.transparent=1!==t})}var d=e.pointer,v=e.keyboard;if(w)if(this.goaled)w.flare("enterframe"),w.update(d,v,this),M.update(),t.camera.rotateAbsY(-.002);else{if("arcade"===this.stage){var x=Math.random();if(x>1-.01*this.difficulty&&E.count()<100){var R={position:new THREE.Vector3(Math.randint(-1e3,1e3),Math.randint(-100,100),Math.randint(-1e3,4e3)).add(w.position),quaternion:(new THREE.Quaternion).rotateY(Math.random()*Math.PI*2)},H=Slot([{weight:6,target:"enem1"},{weight:3,target:function(){return R.aim=!0,"enem1"}},{weight:2,target:"enem2"},{weight:1,target:"enem3"}]);E.createEnemyMulti(H,R,{random:{x:50,y:10,z:50}})}this.difficulty+=1e-4,E.count()>50&&E.removeEnemy(0)}else{for(var S=0;S<u.length;S++){var C=(w.position.x-u[S].position.x)/25,z=(w.position.z-u[S].position.z)/25,_=Math.min(Math.sqrt(Math.pow(C,2)+Math.pow(z,2)),75),I=Math.atan2(C,z)-w.myrot.y+(Math.abs(w.myrot.x)>Math.PI/2&&Math.abs(w.myrot.x)<1.5*Math.PI?Math.PI:0);f[S].setPosition(SCREEN_WIDTH-100+Math.sin(I)*_,SCREEN_HEIGHT-100+Math.cos(I)*_),u[S].update(this)}this.progress=w.position.clone().dot(u.last.position)/u.last.position.clone().dot(u.last.position),E.flare("frame",{progress:this.progress})}if(this.frame%10===0)for(var S=0;S<T.elements.length;S++)T.get(S).position.clone().sub(w.position).length>800&&T.removeBullet(S);if(T.count()>1600)for(;T.count()>1550;)T.removeBullet(0);this.flare("frame"+this.frame),E.flare("frame"+this.frame),w.flare("enterframe"),w.update(d,v,this),M.update(),b.playerposy=w.position.y,s.rotation=Math.radToDeg(-w.myrot.y)+(Math.abs(w.myrot.x)>Math.PI/2&&Math.abs(w.myrot.x)<1.5*Math.PI?0:180),t.camera.position.copy(w.position.clone().add(new THREE.Vector3(0,650,(-200)))),t.camera.lookAt(w.position);var k=2*w.geometry.boundingBox.max.x;if(E.elements.each(c),T.elements.each(c),this.bosscoming&&(null===this.boss.parent?(this.bosscoming=!1,r.tweener.fadeOut(10).play(),this.bossdefeated=!0):r.value=this.boss.hp),v.getKeyDown(32)&&(l.text=""),w.hp<=0){if(E.effectmanager.explode(w.position,10,30),t.scene.remove(w),w=null,m.tweener.to({alpha:1,height:SCREEN_HEIGHT,y:SCREEN_CENTER_Y},5).play(),y.tweener.to({alpha:1,y:SCREEN_CENTER_Y/3},3).play(),g.tweener.wait(10).to({alpha:1,y:.6*SCREEN_CENTER_Y},3).play(),this.score<0&&(this.score=0),g.text="Score: "+this.score.toFixed(0)+"\nKill: "+E.killcount+"("+(E.killcount/E.allcount*100).toFixed(1)+"%)",y.text="Game Over",l.text="",i.tweener.fadeOut(20).play(),"arcade"!==this.stage)for(var S=0;S<f.length;S++)f[S].tweener.fadeOut(20).play();for(var S=0;S<E.count();S++)E.enemyraders[S].tweener.fadeOut(20).play();for(var S=0;S<4;S++)a[S].tweener.fadeOut(20).play();s.tweener.fadeOut(20).play(),n.tweener.fadeOut(20).play(),o.tweener.fadeOut(20).play(),h.tweener.fadeOut(20).play(),p.tweener.fadeOut(20).play()}else if("arcade"!==this.stage&&u.first.enable&&fly.colCup2D3(p1,u.first.position.clone(),v1,new THREE.Vector3(0,0,0),15+u.first.size/2))if(1===u.length){w.tweener.to({auto:1},60).play(),m.tweener.to({alpha:1,height:SCREEN_HEIGHT,y:SCREEN_CENTER_Y},5).play(),y.tweener.to({alpha:1,y:SCREEN_CENTER_Y/3},3).play(),g.tweener.wait(10).to({alpha:1,y:.6*SCREEN_CENTER_Y},3).play();var N="";this.score+=this.rate[0]*w.hp/1e3,N=this.score>=this.rate[3]?"Perfect":this.score>=this.rate[2]?"Good":this.score>=this.rate[1]?"Middle":"Bad",this.score<0&&(this.score=0),g.text="Score: "+this.score.toFixed(0)+(0!==E.allcount?"\nKill: "+E.killcount+"("+(E.killcount/E.allcount*100).toFixed(1)+"%)":"")+"\nLife: "+(w.hp/10).toFixed(1)+"%\nRate: "+N,l.text="",i.tweener.fadeOut(20).play();for(var S=0;S<f.length;S++)f[S].tweener.fadeOut(20).play();for(var S=0;S<E.count();S++)E.enemyraders[S].tweener.fadeOut(20).play();for(var S=0;S<4;S++)a[S].tweener.fadeOut(20).play();s.tweener.fadeOut(20).play(),n.tweener.fadeOut(20).play(),o.tweener.fadeOut(20).play(),h.tweener.fadeOut(20).play(),p.tweener.fadeOut(20).play(),this.goaled=!0}else{var A=u.first.message;this.on("frame"+(this.frame+30),function(){l.text=A}.bind(this)),u.first.parent.remove(u.first),u.splice(0,1),f.first.remove(),f.splice(0,1)}this.frame%600===0&&this.score--,this.frame++}else t.camera.rotateAbsY(-.002);""!==l.text?h.live<.99999&&(h.live+=.5,h.setPosition(SCREEN_CENTER_X*h.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*h.live),h.width=SCREEN_WIDTH/10+SCREEN_WIDTH/1.3*h.live,h.height=SCREEN_HEIGHT/12+SCREEN_HEIGHT/8*h.live,l.setPosition(.2*SCREEN_CENTER_X*h.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*h.live)):h.live>1e-5&&(h.live-=.5,h.setPosition(SCREEN_CENTER_X*h.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*h.live),h.width=SCREEN_WIDTH/10+SCREEN_WIDTH/1.3*h.live,h.height=SCREEN_HEIGHT/12+SCREEN_HEIGHT/5*h.live,l.setPosition(.2*SCREEN_CENTER_X*h.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*h.live)),t.camera.updateMatrixWorld()}.bind(this),e()}]])}}),phina.define("MainSequence",{superClass:"phina.game.ManagerScene",init:function(){this.superInit({scenes:[{className:"LoadingScene",arguments:{lie:!1,assets:{threejson:{fighter:"data/models/fighter-1.min.json",bullet:"data/models/bullet.min.json"},threetexture:{fighter:"data/models/fighter-1.png",plane:"data/images/3.png",explode:"data/images/explosion.png"},text:{expvertexshader:"data/glsl/expvertexshader.glsl",expfragshader:"data/glsl/expfragshader.glsl"}}}},{label:"title",className:"TitleScene",arguments:{width:SCREEN_WIDTH,height:SCREEN_HEIGHT}},{label:"main",className:"MainScene",arguments:{width:SCREEN_WIDTH,height:SCREEN_HEIGHT}}]})}}),phina.define("Application",{superClass:"phina.display.ThreeApp",init:function(){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,query:"#game",fit:!0}),threeext.extention(),this.replaceScene(MainSequence()),this.enableStats()}}),phina.main(function(){var e=Application();e.setupEffect().then(function(){e.run()})});