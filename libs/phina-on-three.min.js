/*!****************************************************************************
 *                               three-text2d                                 *
 ******************************************************************************/
/*!
 * Copyright (c) 2016 Endel Dreyer
 *
 * MIT License:
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
var THREE_text2d=function(t){function e(s){if(i[s])return i[s].exports;var n=i[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,e),n.l=!0,n.exports}var i={};return e.m=t,e.c=i,e.i=function(t){return t},e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:s})},e.n=function(t){var i=t&&t.__esModule?function(){return t["default"]}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=6)}([function(t,e){t.exports=THREE},function(t,e,i){"use strict";function s(t){var e=r[t];if(!e){var i=document.getElementsByTagName("body")[0],s=document.createElement("div"),n=document.createTextNode("MÃ‰q");s.appendChild(n),s.setAttribute("style","font:"+t+";position:absolute;top:0;left:0"),i.appendChild(s),e=s.offsetHeight,r[t]=e,i.removeChild(s)}return e}var n=i(0);e.textAlign={center:new n.Vector2(0,0),left:new n.Vector2(1,0),topLeft:new n.Vector2(1,(-1)),topRight:new n.Vector2((-1),(-1)),right:new n.Vector2((-1),0),bottomLeft:new n.Vector2(1,1),bottomRight:new n.Vector2((-1),1)};var r={};e.getFontHeight=s},function(t,e,i){"use strict";var s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},n=i(0),r=i(1),h=i(5),a=function(t){function e(e,i){void 0===e&&(e=""),void 0===i&&(i={});var s=t.call(this)||this;return s._font=i.font||"30px Arial",s._fillStyle=i.fillStyle||"#FFFFFF",s._shadowColor=i.shadowColor||"rgba(0, 0, 0, 0)",s._shadowBlur=i.shadowBlur||0,s._shadowOffsetX=i.shadowOffsetX||0,s._shadowOffsetY=i.shadowOffsetY||0,s.canvas=new h.CanvasText,s.align=i.align||r.textAlign.center,s.side=i.side||n.DoubleSide,s.antialias="undefined"==typeof i.antialias||i.antialias,s.text=e,s}return s(e,t),Object.defineProperty(e.prototype,"width",{get:function(){return this.canvas.textWidth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.canvas.textHeight},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"text",{get:function(){return this._text},set:function(t){this._text!==t&&(this._text=t,this.updateText())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"font",{get:function(){return this._font},set:function(t){this._font!==t&&(this._font=t,this.updateText())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillStyle",{get:function(){return this._fillStyle},set:function(t){this._fillStyle!==t&&(this._fillStyle=t,this.updateText())},enumerable:!0,configurable:!0}),e.prototype.cleanUp=function(){this.texture&&this.texture.dispose()},e.prototype.applyAntiAlias=function(){this.antialias===!1&&(this.texture.magFilter=n.NearestFilter,this.texture.minFilter=n.LinearMipMapLinearFilter)},e}(n.Object3D);e.Text2D=a},function(t,e,i){"use strict";var s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},n=i(0),r=i(2),h=function(t){function e(e,i){return void 0===e&&(e=""),void 0===i&&(i={}),t.call(this,e,i)||this}return s(e,t),e.prototype.raycast=function(){this.mesh.raycast.apply(this.mesh,arguments)},e.prototype.updateText=function(){this.cleanUp(),this.canvas.drawText(this._text,{font:this._font,fillStyle:this._fillStyle,shadowBlur:this._shadowBlur,shadowColor:this._shadowColor,shadowOffsetX:this._shadowOffsetX,shadowOffsetY:this._shadowOffsetY}),this.texture=new n.Texture(this.canvas.canvas),this.texture.needsUpdate=!0,this.applyAntiAlias(),this.material?this.material.map=this.texture:(this.material=new n.MeshBasicMaterial({map:this.texture,side:this.side}),this.material.transparent=!0),this.mesh||(this.geometry=new n.PlaneGeometry(this.canvas.width,this.canvas.height),this.mesh=new n.Mesh(this.geometry,this.material),this.add(this.mesh)),this.mesh.position.x=this.canvas.width/2-this.canvas.textWidth/2+this.canvas.textWidth/2*this.align.x,this.mesh.position.y=-this.canvas.height/2+this.canvas.textHeight/2*this.align.y,this.geometry.vertices[0].x=this.geometry.vertices[2].x=-this.canvas.width/2,this.geometry.vertices[1].x=this.geometry.vertices[3].x=this.canvas.width/2,this.geometry.vertices[0].y=this.geometry.vertices[1].y=this.canvas.height/2,this.geometry.vertices[2].y=this.geometry.vertices[3].y=-this.canvas.height/2,this.geometry.verticesNeedUpdate=!0},e}(r.Text2D);e.MeshText2D=h},function(t,e,i){"use strict";var s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},n=i(0),r=i(2),h=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e.prototype.raycast=function(){return this.sprite.raycast.apply(this.sprite,arguments)},e.prototype.updateText=function(){this.canvas.drawText(this._text,{font:this._font,fillStyle:this._fillStyle}),this.cleanUp(),this.texture=new n.Texture(this.canvas.canvas),this.texture.needsUpdate=!0,this.applyAntiAlias(),this.material?this.material.map=this.texture:this.material=new n.SpriteMaterial({map:this.texture}),this.sprite||(this.sprite=new n.Sprite(this.material),this.geometry=this.sprite.geometry,this.add(this.sprite)),this.sprite.scale.set(this.canvas.width,this.canvas.height,1),this.sprite.position.x=this.canvas.width/2-this.canvas.textWidth/2+this.canvas.textWidth/2*this.align.x,this.sprite.position.y=-this.canvas.height/2+this.canvas.textHeight/2*this.align.y},e}(r.Text2D);e.SpriteText2D=h},function(t,e,i){"use strict";var s=i(0),n=i(1),r=function(){function t(){this.textWidth=null,this.textHeight=null,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}return Object.defineProperty(t.prototype,"width",{get:function(){return this.canvas.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.canvas.height},enumerable:!0,configurable:!0}),t.prototype.drawText=function(t,e){return this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.font=e.font,this.textWidth=Math.ceil(this.ctx.measureText(t).width),this.textHeight=n.getFontHeight(this.ctx.font),this.canvas.width=s.Math.nextPowerOfTwo(this.textWidth),this.canvas.height=s.Math.nextPowerOfTwo(this.textHeight),this.ctx.font=e.font,this.ctx.fillStyle=e.fillStyle,this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.shadowColor=e.shadowColor,this.ctx.shadowBlur=e.shadowBlur,this.ctx.shadowOffsetX=e.shadowOffsetX,this.ctx.shadowOffsetY=e.shadowOffsetY,this.ctx.fillText(t,0,0),this.canvas},t}();e.CanvasText=r},function(t,e,i){"use strict";var s=i(4);e.SpriteText2D=s.SpriteText2D;var n=i(3);e.MeshText2D=n.MeshText2D;var r=i(1);e.textAlign=r.textAlign}]);/*!****************************************************************************
 *                              END three-text2d                              *
 ******************************************************************************/
phina.define("phina.display.ThreeApp",{superClass:"phina.display.DomApp",init:function(t){t=(t||{}).$safe(phina.display.CanvasApp.defaults),t.query||t.domElement||(this.renderer=new THREE.WebGLRenderer({antialias:!0}),t.domElement=this.renderer.domElement,t.append&&document.body.appendChild(t.domElement)),!t.runner&&phina.isAndroid()&&(t.runner=phina.global.requestAnimationFrame),this.superInit(t),this.renderer||(this.renderer=new THREE.WebGLRenderer({antialias:!0,canvas:this.domElement})),this.renderer.setSize(t.width,t.height),this.scene=new THREE.Scene,this.renderer.setPixelRatio(devicePixelRatio),this.camera=new THREE.OrthographicCamera(0,t.width,0,(-t.height),1,1e4),this.camera.position.z=5e3,this.gridX=phina.util.Grid({width:t.width,columns:t.columns}),this.gridY=phina.util.Grid({width:t.height,columns:t.columns}),this.backgroundColor=void 0!==t.backgroundColor?t.backgroundColor:"white",t.fit&&this.fitScreen(),this.on("changescene",function(){this.currentScene.children.each(function(t){this.scene.remove(t.mesh)},this)})},_draw:function(){this.renderer.setClearColor(new THREE.Color(this.currentScene.backgroundColor||this.backgroundColor),1);var t=function(e,i){if(e._calcWorldMatrix&&e._calcWorldMatrix(),!e.visible)return void(e.mesh&&(e.parent===this.currentScene?this.scene:e.parent.mesh).remove(e.mesh));e.mesh?e.mesh.parent||(e.parent===this.currentScene?this.scene:e.parent.mesh).add(e.mesh):function a(t){t.initThreeMesh?t.mesh=t.initThreeMesh():t.mesh=new THREE.Group,t.mesh.initialQuaternion=t.mesh.quaternion.clone(),t.parent===this.currentScene?this.scene.add(t.mesh):(t.parent.mesh||a(t.parent),t.parent.mesh.add(t.mesh)),t.on("removed",function(){t.mesh.parent&&t.mesh.parent.remove(t.mesh)})}.bind(this)(e),e._calcWorldAlpha&&e._calcWorldAlpha(),e.updateThreeMesh&&e.updateThreeMesh(e.mesh,e._worldAlpha,this),e.mesh.material&&(e.mesh.material.transparent="phina.display.Label"===e.className||"phina.ui.LabelArea"===e.className||1!==e._worldAlpha,e.mesh.material.opacity=e._worldAlpha),e.mesh.quaternion.copy(e.mesh.initialQuaternion.clone().multiply((new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,0,1),Math.degToRad(-e.rotation)))),e.mesh.position.set(e.x-e.width*(e.origin.x-.5),-e.y+e.height*(e.origin.y-.5),i.index);var s={index:0};if(e.renderChildBySelf===!1&&e.children.length>0)for(var n=e.children.slice(),r=0,h=n.length;r<h;++r)s.index+=.01,t(n[r],s);i.index+=s.index}.bind(this),e={index:0};if(this.currentScene.children.length>0)for(var i=this.currentScene.children.slice(),s=0,n=i.length;s<n;++s)t(i[s],e),e.index+=.01;this.render()},render:function(){this.renderer.render(this.scene,this.camera)},fitScreen:function(){var t=function(){var t=this.domElement,e=t.style;e.position="absolute",e.margin="auto",e.left="0",e.top="0",e.bottom="0",e.right="0";var i=this.height/this.width;if(window.innerHeight/window.innerWidth>i)var s=Math.floor(window.innerWidth),n=Math.floor(window.innerWidth*i);else var s=Math.floor(window.innerHeight/i),n=Math.floor(window.innerHeight);this.renderer.setSize(s,n)}.bind(this);t(),phina.global.addEventListener("resize",t,!1)}}),phina.namespace(function(){function t(t,e,i){if(!e)return void(t.visible=!1);var s=phina.util.Color().setFromString(e);return s.a?(t.color=new THREE.Color(s.r/255,s.g/255,s.b/255),s.a*=void 0!==i?i:1,t.opacity=s.a,t.transparent=1!==s.a,void(t.visible=!0)):void(t.visible=!1)}phina.display.RectangleShape.prototype.$extend({initThreeMesh:function(){var t=new THREE.Group,e=new THREE.PlaneBufferGeometry(1,1);return t.fill=new THREE.Mesh(e,new THREE.MeshBasicMaterial({side:THREE.DoubleSide})),t.fill.position.z=.001,t.stroke=new THREE.Mesh(e,new THREE.MeshBasicMaterial),t.add(t.stroke),t.add(t.fill),t},updateThreeMesh:function(e,i){t(e.fill.material,this.fill,i),e.fill.scale.set(this.width*this.scaleX,this.height*this.scaleY,1),t(e.stroke.material,this.stroke,i),e.stroke.scale.set((1+this.strokeWidth/this.width)*this.width*this.scaleX,(1+this.strokeWidth/this.height)*this.height*this.scaleY,1)}}),phina.display.CircleShape.prototype.$extend({initThreeMesh:function(){var t=new THREE.Group,e=new THREE.CircleBufferGeometry(1,128);return t.fill=new THREE.Mesh(e,new THREE.MeshBasicMaterial({side:THREE.DoubleSide})),t.fill.position.z=.001,t.stroke=new THREE.Mesh(e,new THREE.MeshBasicMaterial),t.add(t.stroke),t.add(t.fill),t},updateThreeMesh:function(e,i){t(e.fill.material,this.fill,i),e.fill.scale.set(this.radius*this.scaleX,this.radius*this.scaleY,1),t(e.stroke.material,this.stroke,i);var s=1+this.strokeWidth/this.radius/2;e.stroke.scale.set(s*this.radius*this.scaleX,s*this.radius*this.scaleY,1)}}),phina.display.Label.prototype.$extend({initThreeMesh:function(){return new THREE_text2d.MeshText2D(this.text||" ",{align:THREE_text2d.textAlign[this.align].clone().add(new THREE.Vector2(0,.5)),font:this.font,fillStyle:this.fill})},updateThreeMesh:function(t){t.align=THREE_text2d.textAlign[this.align].clone().add(new THREE.Vector2(0,.5)),t.text=this.text||" ",t.font=this.font,t.fillStyle=this.fill,t.scale.set(this.scaleX,this.scaleY,1)}}),phina.display.ThreeLayer.prototype.$extend({initThreeMesh:function(){return this.renderTarget=new THREE.WebGLRenderTarget(this.width*this.scaleX*devicePixelRatio,this.height*this.scaleY*devicePixelRatio,{}),new THREE.Mesh(new THREE.PlaneBufferGeometry(1,1),new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide,map:this.renderTarget.texture}))},updateThreeMesh:function(t,e,i){var s=i.renderer.getClearColor();i.renderer.setClearColor(this.renderer.getClearColor()),i.renderer.render(this.scene,this.camera,this.renderTarget),i.renderer.setClearColor(s),t.scale.set(this.width*this.scaleX,this.height*this.scaleY,1)}}),phina.ui.Gauge.prototype.$extend({initThreeMesh:function(){var t=new THREE.Group,e=new THREE.PlaneBufferGeometry(1,1);return t.fill=new THREE.Mesh(e,new THREE.MeshBasicMaterial({side:THREE.DoubleSide})),t.fill.position.z=.001,t.stroke=new THREE.Mesh(e,new THREE.MeshBasicMaterial),t.gauge=new THREE.Mesh(e,new THREE.MeshBasicMaterial),t.gauge.position.z=.002,t.add(t.stroke),t.add(t.fill),t.add(t.gauge),t},updateThreeMesh:function(e,i){t(e.fill.material,this.fill,i),e.fill.scale.set(this.width*this.scaleX,this.height*this.scaleY,1),t(e.stroke.material,this.stroke,i),e.stroke.scale.set((1+this.strokeWidth/this.width)*this.width*this.scaleX,(1+this.strokeWidth/this.height)*this.height*this.scaleY,1),t(e.gauge.material,this.gaugeColor,i),e.gauge.position.x=-this.width*this.scaleX*(1-this.getRate())/2,e.gauge.scale.set(this.width*this.scaleX*this.getRate(),this.height*this.scaleY,1)}}),phina.display.Sprite.prototype.$extend({initThreeMesh:function(){var t=new THREE.Mesh(new THREE.PlaneBufferGeometry(1,1),new THREE.MeshBasicMaterial({map:new THREE.Texture(this.canvas.domElement)}));return t},updateThreeMesh:function(t){t.scale.set(this.width*this.scaleX,this.height*this.scaleY,1),this.watchDraw&&this._dirtyDraw===!0&&(this.render(this.canvas),t.material.map.needsUpdate=!0,this._dirtyDraw=!1)}}),phina.ui.LabelArea.prototype.$extend({initThreeMesh:function(){var t=new THREE.Mesh(new THREE.PlaneBufferGeometry(1,1),new THREE.MeshBasicMaterial({map:new THREE.Texture(this.canvas.domElement)}));return t},updateThreeMesh:function(t){t.scale.set(this.width*this.scaleX,this.height*this.scaleY,1),this.watchDraw&&this._dirtyDraw===!0&&(this.render(this.canvas),t.material.map.needsUpdate=!0,this._dirtyDraw=!1)}})}),phina.define("phina.display.ThreeScene",{superClass:"phina.app.Scene",init:function(t){this.superInit(),t={}.$safe(t,phina.display.DisplayScene.defaults),this.width=t.width,this.height=t.height,this.gridX=phina.util.Grid(t.width,16),this.gridY=phina.util.Grid(t.height,16),this.backgroundColor=t.backgroundColor?t.backgroundColor:null,this.interactive=!0,this.setInteractive=function(t){this.interactive=t},this._overFlags={},this._touchFlags={}},hitTest:function(){return!0}});